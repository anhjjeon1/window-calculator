<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²­ê°œêµ¬ë¦¬ ì°½í˜¸ê²¬ì (ë¬´ë£Œ)</title>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        /* [í”Œë«í¼ ìŠ¤íƒ€ì¼ ì •ì˜] */
        :root {
            --primary-color: #1a73e8;
            --bg-color: #f0f4f8;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        body { font-family: 'Pretendard', 'Apple SD Gothic Neo', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: #333; -webkit-font-smoothing: antialiased; }

        /* í—¤ë” */
        header { 
            background: linear-gradient(100deg, #4285f4 0%, #0d47a1 100%);
            padding: 0 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            display: flex; align-items: center; position: sticky; top: 0; z-index: 100; color: white; height: 70px;
        }
        .header-logo-area { flex-shrink: 0; position: absolute; left: 15px; top: 50%; transform: translateY(-50%); z-index: 2; }
        .logo-clipart { width: 50px; height: 50px; object-fit: contain; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3)); background: rgba(255,255,255,0.95); border-radius: 12px; padding: 4px; }
        .main-title { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); margin: 0; font-size: 22px; font-weight: 900; letter-spacing: -0.5px; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap; z-index: 1; width: 100%; pointer-events: none; }
        .sub-info { position: absolute; bottom: 8px; right: 15px; display: flex; align-items: center; gap: 5px; z-index: 2; }
        .ver-badge { font-size: 9px; background: #ffea00; color: #000; padding: 1px 4px; border-radius: 3px; font-weight: 800; }
        .ver-desc { font-size: 9px; color: #e3f2fd; font-weight: 400; letter-spacing: -0.3px; }

        .container { max-width: 768px; margin: 0 auto; padding: 20px; padding-bottom: 120px; }

        /* ì£¼ì†Œ ì…ë ¥ ì˜ì—­ */
        .address-wrapper {
            background: white; padding: 15px; border-radius: 12px; 
            box-shadow: var(--card-shadow); margin-bottom: 20px; border: 1px solid #edf2f7;
        }
        .address-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .address-row input { border: none; background: #f7f9fc; padding: 12px; border-radius: 8px; flex: 1; font-weight: bold; color: #333; outline: none; }
        .btn-search { background: #333; color: white; border: none; padding: 0 15px; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .detail-input { width: 100%; border: 1px solid #e1e4e8; background: #fff; padding: 12px; border-radius: 8px; box-sizing: border-box; font-size: 14px; }

        /* AI ê°€ì´ë“œ */
        .ai-guide-box { background: white; border-radius: 16px; box-shadow: var(--card-shadow); margin-bottom: 25px; display: flex; overflow: hidden; border: 1px solid #d0e2ff; min-height: 110px; }
        .ai-photo-slot { width: 45%; background: #000; position: relative; cursor: pointer; border-right: 1px solid #d0e2ff; display: flex; align-items: center; justify-content: center; padding: 0; overflow: hidden; }
        .ai-btn-img { width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; opacity: 0.85; z-index: 1; }
        .ai-arrow-indicator { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 2; text-align: center; animation: bounceUp 1.5s infinite; }
        .ai-arrow-icon { font-size: 28px; color: #ffff00; text-shadow: 0 2px 4px rgba(0,0,0,0.8); display: block; line-height: 0.8; margin-bottom: 2px; }
        .ai-arrow-text { font-size: 11px; font-weight: 800; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.9); background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 4px; }
        @keyframes bounceUp { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -8px); } }
        .ai-text-slot { width: 55%; padding: 15px; display: flex; flex-direction: column; justify-content: center; }
        .ai-title { font-size: 14px; font-weight: 800; color: #333; margin-bottom: 8px; display: flex; align-items: center; }
        .ai-badge { background: #333; color: white; font-size: 10px; padding: 2px 5px; border-radius: 4px; margin-right: 6px; }
        .guide-list { margin: 0; padding: 0; list-style: none; font-size: 12px; color: #555; line-height: 1.5; }
        .guide-list li { margin-bottom: 6px; position: relative; padding-left: 12px; }
        .guide-list li::before { content: "â€¢"; position: absolute; left: 0; color: var(--primary-color); font-weight: bold; }
        .highlight { color: #d32f2f; font-weight: bold; background: #ffebee; padding: 0 2px; border-radius: 2px; }

        /* [ìˆ˜ì •] ì…ë ¥ ì¹´ë“œ ë° ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° (ê°€ë¡œí˜• 4:3 ë¹„ìœ¨ ì ìš©) */
        .input-card { background: white; border-radius: 16px; box-shadow: var(--card-shadow); margin-bottom: 20px; overflow: hidden; display: flex; flex-direction: column; /* ëª¨ë°”ì¼ì—ì„œ ì‚¬ì§„ì„ í¬ê²Œ ë³´ê¸° ìœ„í•´ ìƒí•˜ ë°°ì¹˜ ì¶”ì²œ, í•˜ì§€ë§Œ ìš”ì²­ëŒ€ë¡œ 4:3 ìœ ì§€í•˜ë©° ë°°ì¹˜ */ }
        @media (min-width: 400px) {
            .input-card { flex-direction: row; }
            .photo-area { width: 50%; aspect-ratio: 4/3; } /* ê°€ë¡œí˜• 4:3 ë¹„ìœ¨ */
            .dim-area { width: 50%; }
        }
        
        .photo-area { 
            width: 100%; aspect-ratio: 4/3; /* ëª¨ë°”ì¼ ê¸°ë³¸ ê°€ë¡œí˜• ë¹„ìœ¨ */
            background: #000; border-right: 1px solid #edf2f7; border-bottom: 1px solid #edf2f7;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            position: relative; cursor: pointer; overflow: hidden; 
        }
        
        /* [ìˆ˜ì •] ì‚¬ì§„ì´ ì˜ë¦¬ì§€ ì•Šê³  ì „ì²´ê°€ ë³´ì´ë„ë¡ contain ì ìš© */
        .photo-preview { width: 100%; height: 100%; object-fit: contain; display: none; background: #000; } 
        
        .default-icon-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background: #f8fafc; }
        .camera-circle { width: 40px; height: 40px; background: #e3f2fd; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
        .camera-circle i { font-size: 20px; color: var(--primary-color); font-style: normal; }
        .photo-label { font-size: 12px; color: #555; font-weight: 600; text-align: center; } 
        
        /* [ìˆ˜ì •] capture ì†ì„± ì œê±°í•˜ì—¬ ê°¤ëŸ¬ë¦¬/ì¹´ë©”ë¼ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ í•¨ */
        .photo-input-hidden { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; left:0; top:0; z-index: 10; }
        
        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .ai-loading {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.6); z-index: 20;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            font-weight: bold; color: #fff; font-size: 14px;
            backdrop-filter: blur(2px);
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff;
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .dim-area { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 8px; justify-content: center;}
        .row-title { font-size: 15px; color: var(--primary-color); font-weight: 800; margin-bottom: 2px; }
        select, input[type="number"] { width: 100%; padding: 0 10px; height: 42px; border: 1px solid #e1e4e8; border-radius: 8px; font-size: 14px; background: #fff; box-sizing: border-box; }
        .form-row { display: flex; gap: 8px; }

        /* [ìˆ˜ì •] ë²„íŠ¼ ê·¸ë£¹ (ì—…ì²´ë³„ ê°€ê²©ë¹„êµ, ë¹„êµ ì €ì¥ 1ì—´ ë°°ì¹˜) */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-calc { flex: 6; padding: 18px; background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%); color: white; border: none; border-radius: 12px; font-size: 17px; font-weight: 800; cursor: pointer; box-shadow: 0 8px 15px rgba(26, 115, 232, 0.3); }
        .btn-save { flex: 4; padding: 18px; background: #ff9800; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 800; cursor: pointer; box-shadow: 0 8px 15px rgba(255, 152, 0, 0.3); display: flex; align-items: center; justify-content: center; gap:5px; }

        .disclaimer-box { text-align: center; margin-top: 15px; padding: 12px; background: #fff8e1; border-radius: 12px; border: 1px solid #ffe0b2; color: #8d6e63; font-size: 12px; line-height: 1.5; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1); word-break: keep-all; margin-bottom: 25px; }

        .result-section { display: none; margin-top: 20px; border-top: 2px dashed #ddd; padding-top: 30px; }
        .chart-box { background: white; padding: 25px 20px; border-radius: 16px; box-shadow: var(--card-shadow); margin-bottom: 30px; }
        .chart-title { font-size: 17px; font-weight: 800; margin-bottom: 20px; color: #222; }
        .graph-row { display: flex; align-items: center; margin-bottom: 15px; font-size: 13px; }
        .g-label { width: 50px; font-weight: 700; color: #555; }
        .g-bar-area { flex: 1; height: 32px; background: #f1f3f5; border-radius: 6px; overflow: hidden; position: relative; margin: 0 12px; }
        .g-bar { height: 100%; background: #aeb5bc; width: 0%; transition: width 1s; border-radius: 6px; }
        .g-bar.best { background: #ff6b6b; } 
        .g-bar.second { background: #339af0; }
        .g-price { width: 75px; text-align: right; font-weight: 800; color: #333; font-size: 14px; }

        .contact-title { font-size: 16px; font-weight: 800; color: #333; margin-bottom: 10px; text-align: center; border-top: 1px solid #eee; padding-top: 20px; }
        .contact-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 30px; }
        .btn-call { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px 5px; border-radius: 8px; text-decoration: none; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.15); transition: transform 0.1s; position: relative; min-height: 70px; }
        .btn-call:active { transform: translateY(2px); }
        .c-A { background: #E53935; } .c-B { background: #FB8C00; } .c-C { background: #FDD835; color: #333; }
        .c-D { background: #43A047; } .c-E { background: #1E88E5; } .c-F { background: #8E24AA; }
        .btn-call strong { font-size: 14px; margin-bottom: 2px; }
        .btn-call span { font-size: 10px; opacity: 0.9; white-space: nowrap; }
        .icon-phone { font-size: 16px; margin-bottom: 4px; opacity: 0.9; font-style: normal; }

        footer { background: #212529; color: #adb5bd; padding: 25px 15px; text-align: center; }
        .footer-line { display: block; font-size: 11px; line-height: 1.6; word-break: keep-all; }
        .f-divider { color: #495057; margin: 0 6px; font-size: 10px; }
        .f-highlight { color: #fff; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <div class="header-logo-area">
        <img src="logo.png" alt="ê²¬ì ì„œ ë¡œê³ " class="logo-clipart" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3176/3176366.png'"> 
    </div>
    <h1 class="main-title">ì²­ê°œêµ¬ë¦¬ ì°½í˜¸ê²¬ì (ë¬´ë£Œ)</h1>
    <div class="sub-info">
        <span class="ver-badge">Ver 5.0 AI</span>
        <span class="ver-desc">AI + ê°€ë¡œí˜•</span>
    </div>
</header>

<div class="container" id="captureArea">
    
    <div class="address-wrapper">
        <div class="address-row">
            <input type="text" id="aptAddress" placeholder="ì£¼ì†Œ ê²€ìƒ‰ í´ë¦­ (ì˜ˆ: ëŒ€ì¹˜ë™)" readonly onclick="openAddressSearch()">
            <button class="btn-search" onclick="openAddressSearch()">ğŸ” ì£¼ì†Œì°¾ê¸°</button>
        </div>
        <input type="text" class="detail-input" id="detailAddress" placeholder="ìƒì„¸ ì£¼ì†Œ ì…ë ¥ (ì˜ˆ: 101ë™ 1204í˜¸)">
    </div>

    <div class="ai-guide-box">
        <div class="ai-photo-slot">
            <img src="Gemini_Generated_Image_lk91n8lk91n8lk91.png" alt="AIì¸¡ì •" class="ai-btn-img" onerror="this.style.display='none';">
            <div class="ai-arrow-indicator">
                <span class="ai-arrow-icon">â–²</span>
                <span class="ai-arrow-text">A4 ìœ„ì¹˜</span>
            </div>
            </div>
        <div class="ai-text-slot">
            <div class="ai-title"><span class="ai-badge">Tip</span> ì¹˜ìˆ˜ ì¸¡ì • ë°©ë²•</div>
            <ul class="guide-list">
                <li><strong>ë°©ë²• 1 (AI ìë™):</strong> ì°½ë¬¸ì— <span class="highlight">A4 ìš©ì§€</span>ë¥¼ ë¶™ì´ê³  ì •ë©´ ì´¬ì˜ ì‹œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.</li>
                <li><strong>ë°©ë²• 2 (ì§ì ‘ ì…ë ¥):</strong> ì¤„ìë¡œ ì‹¤ì¸¡í•˜ì—¬ ì•„ë˜ ì¹¸ì— ì ì–´ì£¼ì„¸ìš”.</li>
            </ul>
        </div>
    </div>

    <div id="inputListArea"></div>

    <div class="btn-group">
        <button class="btn-calc" onclick="calculateEstimates()">âœ¨ ì—…ì²´ë³„ ê°€ê²©ë¹„êµ</button>
        <button class="btn-save" onclick="saveAsImage()">ğŸ“¸ ë¹„êµ ì €ì¥</button>
    </div>

    <div class="disclaimer-box">
        <strong style="display:block; margin-bottom:4px;">âš ï¸ ê²¬ì  ìœ ì˜ì‚¬í•­</strong>
        ìƒê¸° ê²¬ì ì€ ì‹œê³µì—¬ê±´ê³¼ ì¶”ê°€ì˜µì…˜ì— ë”°ë¥¸ ë¹„ìš©ìƒìŠ¹ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
        ì „ë¬¸ ë§¤ë‹ˆì €ì˜ <strong>ë¬´ë£Œ ë°©ë¬¸ ì‹¤ì¸¡</strong>ì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.
    </div>

    <div class="contact-title">ğŸ“ ì œíœ´ ì‹œê³µì‚¬ ë‹¤ì´ë ‰íŠ¸ ì—°ê²°</div>
    <div class="contact-grid">
        <a href="tel:01000000001" class="btn-call c-A"><i class="icon-phone">ğŸ“</i><strong>Aì‚¬</strong><span>í‘œì¤€ì‹œê³µ</span></a>
        <a href="tel:01000000002" class="btn-call c-B"><i class="icon-phone">ğŸ“</i><strong>Bì‚¬</strong><span>ì•Œëœ°í˜•</span></a>
        <a href="tel:01000000003" class="btn-call c-C"><i class="icon-phone">ğŸ“</i><strong>Cì‚¬</strong><span>í”„ë¦¬ë¯¸ì—„</span></a>
        <a href="tel:01000000004" class="btn-call c-D"><i class="icon-phone">ğŸ“</i><strong>Dì‚¬</strong><span>ë¹ ë¥¸ì‹œê³µ</span></a>
        <a href="tel:01000000005" class="btn-call c-E"><i class="icon-phone">ğŸ“</i><strong>Eì‚¬</strong><span>íŠ¹í™”ì‹œê³µ</span></a>
        <a href="tel:01000000006" class="btn-call c-F"><i class="icon-phone">ğŸ“</i><strong>Fì‚¬</strong><span>ì¹œì ˆìƒë‹´</span></a>
    </div>

    <div id="resultSection" class="result-section">
        <div class="chart-box">
            <div class="chart-title">ğŸ“Š ì—…ì²´ë³„ ì˜ˆìƒ ê²¬ì  ë¹„êµ</div>
            <div id="graphContainer"></div>
        </div>
    </div>
</div>

<footer>
    <div class="footer-line">
        <span class="f-highlight">ì²­ê°œêµ¬ë¦¬ìƒ¤ì‹œ</span> <span class="f-divider">|</span>
        ì‚¬ì—…ì : 123-36-31426 <span class="f-divider">|</span>
        ëŒ€í‘œ : ì „ì˜ì›…
    </div>
    <div class="footer-line">
        ê³ ê°ì„¼í„° 1599-7380 (08ì‹œ~17ì‹œ) <span class="f-divider">|</span>
        COPYRIGHT â“’ 2026
    </div>
</footer>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // ğŸ”´ [ë³´ì•ˆ] 3ë¶„í•  í‚¤ (ìˆ˜ì • ê¸ˆì§€)
    const KEY_PART_1 = "AIzaSyAq7G2mE2qFuUi";
    const KEY_PART_2 = "f-";
    const KEY_PART_3 = "PgPDsXl1ppbY5_JK54";
    const API_KEY = KEY_PART_1 + KEY_PART_2 + KEY_PART_3;

    // AI ì´ë¯¸ì§€ ë¶„ì„ í•¨ìˆ˜ (ë¯¸ë¦¬ë³´ê¸° + ë¶„ì„)
    window.handleImageUpload = async function(inputElement, index) {
        const file = inputElement.files[0];
        if (!file) return;

        // 1. ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ì¦‰ì‹œ ì‹¤í–‰)
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('defaultIcon_' + index).style.display = 'none';
            const img = document.getElementById('previewImg_' + index);
            img.src = e.target.result;
            img.style.display = 'block';
        }
        reader.readAsDataURL(file);

        // 2. AI ë¶„ì„ ì‹œì‘ (ë¡œë”© í‘œì‹œ)
        const loadingOverlay = document.getElementById(`loading_${index}`);
        loadingOverlay.style.display = 'flex';

        try {
            const genAI = new GoogleGenerativeAI(API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            
            const imagePart = await fileToGenerativePart(file);
            
            const prompt = `
                ë‹¹ì‹ ì€ ì°½í˜¸ ê²¬ì  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì´ ì‚¬ì§„ì„ ë¶„ì„í•˜ì—¬ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µí•˜ì„¸ìš”.
                
                1. ì°½í˜¸ ì¢…ë¥˜ íŒë‹¨ (typeCode):
                   - "S_BAL": ë°œì½”ë‹ˆìš© ë‹¨ì°½(ì™¸ë¶€ì™€ ë§ë‹¿ì€ ë‚œê°„ì´ ìˆëŠ” ì°½)
                   - "S_IN": ë‚´ë¶€ìš© ë‹¨ì°½(ë°© ì•ˆìª½ ì°½)
                   - "D_IN": ë‚´ë¶€ìš© ì´ì¤‘ì°½(ì°½ë¬¸ì´ ë‘ ê²¹)
                   - "D_EXT": í™•ì¥í˜• ì´ì¤‘ì°½(ë‘êº¼ìš´ í”„ë ˆì„)
                   - "SYS": ì‹œìŠ¤í…œì°½/í„°ë‹ë„ì–´
                   - "PJ": í”„ë¡œì íŠ¸ì°½
                   (ë¶ˆí™•ì‹¤í•˜ë©´ S_IN ìœ¼ë¡œ ì¶”ì •)

                2. ì‚¬ì´ì¦ˆ ì¸¡ì • (width, height):
                   - ì‚¬ì§„ ì†ì— A4ìš©ì§€(210x297mm)ë¥¼ ì°¾ì•„ì„œ ê·¸ê²ƒì„ ê¸°ì¤€ìœ¼ë¡œ ì°½í‹€ ì „ì²´(í”„ë ˆì„ í¬í•¨) í¬ê¸°ë¥¼ mm ë‹¨ìœ„ë¡œ ê³„ì‚°í•˜ì„¸ìš”.
                   - A4ìš©ì§€ê°€ ì•ˆ ë³´ì´ë©´ ì¼ë°˜ì ì¸ ì•„íŒŒíŠ¸ ì°½ë¬¸ ê·œê²©ì„ ì°¸ê³ í•˜ì—¬ ì¶”ì •í•˜ì„¸ìš”. (ì˜ˆ: ê±°ì‹¤ 3000x2300)
                
                3. ì‘ë‹µ í˜•ì‹ (ì˜¤ì§ JSONë§Œ):
                {
                    "typeCode": "ë¬¸ìì—´",
                    "width": ìˆ«ì,
                    "height": ìˆ«ì
                }
            `;

            const result = await model.generateContent([prompt, imagePart]);
            const response = await result.response;
            const text = response.text().replace(/```json|```/g, "").trim();
            const data = JSON.parse(text);

            // ë°ì´í„° ìë™ ì…ë ¥
            if(data.typeCode) document.getElementById(`type_${index}`).value = data.typeCode;
            if(data.width) document.getElementById(`w_${index}`).value = data.width;
            if(data.height) document.getElementById(`h_${index}`).value = data.height;

            // ì™„ë£Œ ì•Œë¦¼ ëŒ€ì‹  ì‚´ì§ ì§„ë™ì´ë‚˜ ì½˜ì†” ë¡œê·¸ (ì‚¬ìš©ì ê²½í—˜ ìœ„í•´)
            console.log("AI ë¶„ì„ ì™„ë£Œ:", data);

        } catch (error) {
            console.error(error);
            alert("AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        } finally {
            loadingOverlay.style.display = 'none';
        }
    };

    async function fileToGenerativePart(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64Data = reader.result.split(',')[1];
                resolve({
                    inlineData: {
                        data: base64Data,
                        mimeType: file.type
                    }
                });
            };
            reader.readAsDataURL(file);
        });
    }

    // ì£¼ì†Œ ì°¾ê¸° ë° ê¸°íƒ€ ê¸°ëŠ¥ (window ê°ì²´ì— í• ë‹¹)
    window.openAddressSearch = function() {
        new daum.Postcode({
            oncomplete: function(data) {
                var roadAddr = data.roadAddress; 
                var jibunAddr = data.jibunAddress; 
                if(roadAddr !== ''){
                    document.getElementById("aptAddress").value = roadAddr + " (" + data.buildingName + ")";
                } else {
                    document.getElementById("aptAddress").value = jibunAddr;
                }
                document.getElementById("detailAddress").focus();
            }
        }).open();
    }

    window.saveAsImage = function() {
        alert("ê²¬ì  ê²°ê³¼ë¥¼ ì´ë¯¸ì§€ë¡œ ì €ì¥í•©ë‹ˆë‹¤.\n(ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...)");
        const captureArea = document.body;
        html2canvas(captureArea).then(canvas => {
            const link = document.createElement('a');
            link.download = 'ì²­ê°œêµ¬ë¦¬_ê²¬ì ê²°ê³¼_' + new Date().getTime() + '.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    // ì´ˆê¸°í™” ë° UI ìƒì„±
    const locations = ["ê±°ì‹¤", "ì•ˆë°©", "ì¹¨ì‹¤1", "ì¹¨ì‹¤2", "ì¹¨ì‹¤3", "ì£¼ë°©", "ë°œì½”ë‹ˆ1", "ë°œì½”ë‹ˆ2", "í„°ë‹ë„ì–´"];
    const inputArea = document.getElementById('inputListArea');
    const windowOptions = `
        <option value="S_IN">ë‚´ë¶€ìš© ë‹¨ì°½ (ë°©ì°½)</option>
        <option value="S_BAL">ë°œì½”ë‹ˆìš© ë‹¨ì°½ (ì™¸ë¶€)</option>
        <option value="D_IN">ë‚´ë¶€ìš© ì´ì¤‘ì°½</option>
        <option value="D_EXT">í™•ì¥í˜• ì´ì¤‘ì°½ (ë‹¨ì—´â†‘)</option>
        <option value="SYS">ê³µí‹€ì¼ì²´í˜• / ì‹œìŠ¤í…œì°½</option>
        <option value="PJ">PJì°½ / í”„ë¡œì íŠ¸ì°½</option>
    `;

    locations.forEach((loc, index) => {
        const html = `
            <div class="input-card">
                <div id="loading_${index}" class="ai-loading">
                    <div class="spinner"></div>
                    <span>AI ì¸¡ì •ì¤‘...</span>
                </div>

                <div class="photo-area">
                    <div id="defaultIcon_${index}" class="default-icon-wrap">
                        <div class="camera-circle"><i>ğŸ“·</i></div>
                        <div class="photo-label">ì‚¬ì§„ì´¬ì˜<br>(A4ë¶€ì°©)</div>
                        <div style="font-size:10px; color:#ff6b6b; font-weight:bold; margin-top:4px;">AI ì¸¡ì •</div>
                    </div>
                    <img id="previewImg_${index}" class="photo-preview">
                    <input type="file" accept="image/*" class="photo-input-hidden" onchange="handleImageUpload(this, ${index})">
                </div>

                <div class="dim-area">
                    <div class="row-title">NO.${index + 1} &nbsp;${loc}</div>
                    <div class="form-row">
                        <select id="loc_${index}" style="flex:1;">
                            <option value="${loc}" selected>${loc}</option>
                            ${locations.map(l => `<option value="${l}">${l}</option>`).join('')}
                        </select>
                    </div>
                    <select id="type_${index}" style="margin-bottom:5px;">${windowOptions}</select>
                    <div class="form-row">
                        <input type="number" id="w_${index}" placeholder="ê°€ë¡œ mm">
                        <input type="number" id="h_${index}" placeholder="ì„¸ë¡œ mm">
                    </div>
                </div>
            </div>
        `;
        inputArea.innerHTML += html;
    });

    // ê³„ì‚° ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    const companyDB = {
        'Aì‚¬': { name: 'Aì‚¬ (í‘œì¤€)', specs: { 'S_IN': 13000, 'S_BAL': 14000, 'D_IN': 20000, 'D_EXT': 24000, 'SYS': 14000, 'PJ': 15000 } },
        'Bì‚¬': { name: 'Bì‚¬ (ì•Œëœ°)', specs: { 'S_IN': 12500, 'S_BAL': 13500, 'D_IN': 19500, 'D_EXT': 23500, 'SYS': 13500, 'PJ': 14500 } },
        'Cì‚¬': { name: 'Cì‚¬ (ê³ ê¸‰)', specs: { 'S_IN': 15000, 'S_BAL': 16000, 'D_IN': 22000, 'D_EXT': 26000, 'SYS': 16000, 'PJ': 17000 } },
        'Dì‚¬': { name: 'Dì‚¬ (ë¹ ë¥¸)', specs: { 'S_IN': 13200, 'S_BAL': 14200, 'D_IN': 20200, 'D_EXT': 24200, 'SYS': 14200, 'PJ': 15200 } },
        'Eì‚¬': { name: 'Eì‚¬ (íŠ¹í™”)', specs: { 'S_IN': 12800, 'S_BAL': 13800, 'D_IN': 19800, 'D_EXT': 23800, 'SYS': 13800, 'PJ': 14800 } },
        'Fì‚¬': { name: 'Fì‚¬ (ì¹œì ˆ)', specs: { 'S_IN': 14000, 'S_BAL': 15000, 'D_IN': 21000, 'D_EXT': 25000, 'SYS': 15000, 'PJ': 16000 } }
    };

    window.calculateEstimates = function() {
        let totalArea = 0;
        let requestList = [];

        for(let i=0; i<9; i++) {
            const w = parseFloat(document.getElementById(`w_${i}`).value) || 0;
            const h = parseFloat(document.getElementById(`h_${i}`).value) || 0;
            const typeCode = document.getElementById(`type_${i}`).value;

            if (w > 0 && h > 0) {
                const pyeong = (w * h) / 90000;
                requestList.push({ typeCode: typeCode, qty: pyeong });
                totalArea += pyeong;
            }
        }

        if (totalArea === 0) {
            alert("ì •í™•í•œ ê²¬ì ì„ ìœ„í•´ ì¹˜ìˆ˜ë¥¼ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        let results = [];
        const compKeys = Object.keys(companyDB);

        compKeys.forEach(key => {
            const comp = companyDB[key];
            let totalCost = 0;
            requestList.forEach((req) => {
                const price = comp.specs[req.typeCode] || 0;
                totalCost += price * req.qty;
            });
            const baseCost = 1000000 + (totalArea * 10000); 
            results.push({ name: comp.name, price: Math.floor(totalCost + baseCost) });
        });

        renderGraph(results);
    }

    function renderGraph(data) {
        const resultSection = document.getElementById('resultSection');
        const graphContainer = document.getElementById('graphContainer');
        resultSection.style.display = 'block';
        graphContainer.innerHTML = '';

        data.sort((a, b) => a.price - b.price);
        const maxPrice = Math.max(...data.map(d => d.price));

        data.forEach((item, idx) => {
            const percent = (item.price / maxPrice) * 100;
            let barClass = 'g-bar';
            if (idx === 0) barClass += ' best'; 
            else if (idx === 1) barClass += ' second'; 

            const html = `
                <div class="graph-row">
                    <div class="g-label">${item.name.split(' ')[0]}</div>
                    <div class="g-bar-area">
                        <div class="g-bar" style="width: 0%;"></div> 
                    </div>
                    <div class="g-price">${item.price.toLocaleString()}ì›</div>
                </div>
            `;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            graphContainer.appendChild(tempDiv.querySelector('.graph-row'));
            
            setTimeout(() => {
                const bars = graphContainer.querySelectorAll('.g-bar');
                bars[idx].style.width = percent + '%';
                if(idx === 0) bars[idx].classList.add('best');
                else if(idx === 1) bars[idx].classList.add('second');
            }, 100);
        });

        resultSection.scrollIntoView({ behavior: 'smooth' });
    }
</script>
</body>
</html>
