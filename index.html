<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì²­ê°œêµ¬ë¦¬ ì°½í˜¸ê²¬ì  (ì „ë¬¸ê°€ìš©)</title>

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://anhjjeon1.github.io/window-calculator/">
    <meta property="og:title" content="ì²­ê°œêµ¬ë¦¬ ì°½í˜¸ê²¬ì  AI (ì§ê±°ë˜ ìµœì €ê°€)">
    <meta property="og:description" content="ìƒì‚°ì-ì†Œë¹„ì ì§ê²°! ê±°í’ˆ ì—†ëŠ” AI ì‹¤ì‹œê°„ ë¬´ë£Œ ê²¬ì ì„ í™•ì¸í•˜ì„¸ìš”.">
    <meta property="og:image" content="https://anhjjeon1.github.io/window-calculator/image_1.png">
    
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        /* [í•µì‹¬] ì „ë¬¸ì ì¸ ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        :root { 
            --primary-color: #004a99; /* ì‹ ë¢°ê° ì£¼ëŠ” ë”¥ ë¸”ë£¨ */
            --secondary-color: #f5f7fa; /* ê¹¨ë—í•œ ë°°ê²½ìƒ‰ */
            --accent-color: #00c853; /* ê°•ì¡° í¬ì¸íŠ¸ ìƒ‰ìƒ (ì„±ê³µ, ìµœì €ê°€) */
            --text-color: #2c3e50; /* ê°€ë…ì„± ë†’ì€ ì§„í•œ íšŒìƒ‰ */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --border-radius: 12px;
        }
        body { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: var(--secondary-color);
            margin: 0; padding: 0; color: var(--text-color);
            -webkit-font-smoothing: antialiased; line-height: 1.5;
        }

        /* [ë””ìì¸ ê°œí¸] í—¤ë” ìŠ¤íƒ€ì¼ */
        header { 
            background: white;
            padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: center;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; 
            box-shadow: 0 1px 5px rgba(0,0,0,0.05); box-sizing: border-box;
            border-bottom: 1px solid #eee;
        }
        .logo-clipart { 
            width: 36px; height: 36px; 
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
            object-fit: contain;
        }
        .main-title { margin: 0; font-size: 18px; font-weight: 800; color: var(--primary-color); }
        .ver-badge { 
            font-size: 10px; background: var(--primary-color); color: white; 
            padding: 4px 8px; border-radius: 20px; font-weight: 600; 
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container { max-width: 600px; margin: 0 auto; padding: 20px; padding-top: 80px; padding-bottom: 100px; }

        /* [ì‹ ê·œ] ìµœìƒë‹¨ ì•ˆë‚´ ë¬¸êµ¬ ë°•ìŠ¤ (ì‹ ë¢°ë„ ìƒìŠ¹) */
        .intro-disclaimer {
            background: #e3f2fd; /* ë¶€ë“œëŸ¬ìš´ ë¸”ë£¨í†¤ ë°°ê²½ */
            border: 1px solid #bbdefb;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            box-shadow: var(--shadow-sm);
        }
        .intro-icon { font-size: 20px; }
        .intro-text { font-size: 13px; color: #0d47a1; font-weight: 600; line-height: 1.6; margin: 0; }
        .intro-highlight { color: #d32f2f; font-weight: 800; text-decoration: underline; }

        /* [ë””ìì¸ ê°œí¸] ì…ë ¥ í•„ë“œ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .address-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .address-row input, .detail-input, .info-select { 
            flex: 1; padding: 14px; border: 1px solid #ddd; border-radius: var(--border-radius); 
            background: white; font-weight: 600; font-size: 14px; color: var(--text-color);
            transition: border-color 0.2s;
        }
        .address-row input:focus, .detail-input:focus, .info-select:focus, 
        select:focus, input[type="number"]:focus { border-color: var(--primary-color); outline: none; }
        
        .btn-search { 
            background: var(--primary-color); color: white; border: none; padding: 0 18px; 
            border-radius: var(--border-radius); font-size: 18px; cursor: pointer; 
        }
        
        .info-row { display: flex; gap: 10px; margin-top: 10px; margin-bottom: 20px; }
        .info-select {
            appearance: none; 
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 12px center; background-size: 16px;
            background-color: white;
        }

        /* [ë””ìì¸ ê°œí¸] ì…ë ¥ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .input-card { 
            background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); 
            margin-bottom: 15px; display: flex; height: 140px; overflow: hidden; border: 1px solid #eee; 
        }
        .photo-area { 
            width: 35%; background: #37474f; position: relative; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; 
        }
        .photo-area img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .camera-icon { font-size: 24px; margin-bottom: 5px; color: rgba(255,255,255,0.9); }
        .photo-hint { font-size: 11px; color: rgba(255,255,255,0.7); text-align: center; line-height: 1.4; }
        .photo-input-hidden { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; left:0; top:0; }
        
        .dim-area { width: 65%; padding: 15px; display: flex; flex-direction: column; justify-content: center; gap: 10px; }
        
        .row-head { display: flex; justify-content: space-between; align-items: center; }
        .row-number { font-size: 14px; font-weight: 800; color: var(--primary-color); margin-right: 6px; }
        .loc-select { 
            font-size: 16px; font-weight: 700; color: var(--text-color); border: none; background: transparent; 
            cursor: pointer; outline: none; padding: 0; border-bottom: 1px dashed #ccc;
        }
        .badge-ai { 
            font-size: 10px; background: var(--accent-color); color: white; 
            padding: 3px 8px; border-radius: 20px; display: none; font-weight: 700; 
        }
        select, input[type="number"] { 
            width: 100%; height: 40px; border: 1px solid #ddd; border-radius: 8px; 
            font-size: 13px; padding: 0 10px; box-sizing: border-box; background: white; 
        }
        .size-inputs { display: flex; gap: 8px; }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .loading-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 20; display: none; 
            flex-direction: column; justify-content: center; align-items: center; color: white; 
        }
        .spinner { 
            width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); 
            border-top: 3px solid white; border-radius: 50%; 
            animation: spin 1s linear infinite; margin-bottom: 8px; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* [ë””ìì¸ ê°œí¸] ë©”ì¸ ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; gap: 12px; margin-top: 30px; margin-bottom: 25px; }
        .btn-main { 
            flex: 1; padding: 16px; border-radius: var(--border-radius); border: none; 
            font-weight: 800; cursor: pointer; color: white; font-size: 16px; 
            box-shadow: var(--shadow-md); transition: all 0.2s; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-main:active { transform: scale(0.98); box-shadow: var(--shadow-sm); }
        .btn-calc { background: linear-gradient(135deg, #004a99, #003366); }
        .btn-save { background: linear-gradient(135deg, #ff6f00, #e65100); }

        /* [ì¤‘ìš”] ì—…ì²´ ë²„íŠ¼ ê·¸ë¦¬ë“œ & ì „í™” ì—°ê²° ìŠ¤íƒ€ì¼ */
        .company-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); /* 2ì¤„ 3ì¹¸ -> 2ì—´ë¡œ ë³€ê²½í•˜ì—¬ ê°€ë…ì„± í™•ë³´ */
            gap: 10px; margin-bottom: 30px;
        }
        .comp-btn {
            padding: 12px; border-radius: var(--border-radius);
            color: white; font-weight: 700; font-size: 13px;
            text-align: left; border: none; cursor: pointer;
            box-shadow: var(--shadow-sm); transition: all 0.2s;
            display: flex; align-items: center; justify-content: space-between; /* ì•„ì´ì½˜ ìš°ì¸¡ ì •ë ¬ */
            background: white; border: 1px solid #eee;
            color: var(--text-color); /* ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
        }
        .comp-btn:active { transform: translateY(2px); }
        .comp-btn .phone-icon { font-size: 16px; color: var(--primary-color); } /* ì „í™” ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        
        /* ì—…ì²´ë³„ í¬ì¸íŠ¸ ì»¬ëŸ¬ ë¼ì¸ */
        .cb-1 { border-left: 4px solid #2980b9; } 
        .cb-2 { border-left: 4px solid #c0392b; } 
        .cb-3 { border-left: 4px solid #27ae60; } 
        .cb-4 { border-left: 4px solid #f39c12; } 
        .cb-5 { border-left: 4px solid #8e44ad; } 
        .cb-6 { border-left: 4px solid #7f8c8d; } 

        /* [ë””ìì¸ ê°œí¸] ê²°ê³¼ì°½ ìŠ¤íƒ€ì¼ */
        .chart-box { 
            background: white; padding: 25px; border-radius: 16px; margin-top: 10px; 
            box-shadow: var(--shadow-md); border: 1px solid #eee;
        }
        .chart-header { 
            font-weight: 900; font-size: 18px; text-align: center; color: var(--text-color);
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;
        }
        
        .trust-notice {
            background-color: #fff3e0; border-left: 4px solid #ff9800;
            padding: 15px; border-radius: 8px; font-size: 12px; color: #5d4037;
            line-height: 1.6; margin-bottom: 30px;
        }
        .trust-notice strong { color: #d84315; }

        .graph-row { display: flex; align-items: center; margin-bottom: 15px; position: relative; }
        .g-label { width: 80px; font-size: 12px; font-weight: 700; color: #546e7a; text-align: right; padding-right: 12px; }
        .g-bar-bg { flex: 1; height: 24px; background: #eceff1; border-radius: 12px; overflow: visible; }
        .g-bar { 
            height: 100%; background: #b0bec5; width: 0%; transition: width 1s ease-out; 
            border-radius: 12px; position: relative;
        }
        .g-bar.best { background: linear-gradient(90deg, #00c853, #64dd17); } 
        .g-bar.second { background: linear-gradient(90deg, #29b6f6, #039be5); }
        .g-price { width: 80px; text-align: right; font-weight: 800; color: var(--text-color); font-size: 14px; margin-left: 10px; }
        
        .badge-best { 
            position: absolute; right: -5px; top: -10px; 
            background: #d32f2f; color: white; font-size: 10px; padding: 2px 6px; 
            border-radius: 10px; font-weight: 800; z-index: 10; border: 1px solid white;
        }

        /* ìƒì„¸ ê²¬ì ì„œ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .d-title { font-size: 16px; font-weight: 800; margin: 40px 0 15px 0; display: flex; align-items: center; gap: 8px; color: var(--primary-color); }
        .d-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 12px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        .d-table th { background: #f8f9fa; padding: 12px 8px; font-weight: 700; color: #555; border-bottom: 1px solid #eee; text-align: center; }
        .d-table td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: center; color: #333; }
        .d-table tr:last-child td { border-bottom: none; }
        .d-table td.left { text-align: left; }
        .total-row td { background: #f1f8e9; font-weight: 800; font-size: 14px; color: var(--primary-color); }
        .total-price { color: #d32f2f; font-size: 16px; font-weight: 900; }

        .estimate-note { margin-top: 20px; padding: 15px; font-size: 11px; color: #78909c; background: #fcfcfc; border-radius: 8px; border: 1px solid #eee; }

        footer { text-align: center; font-size: 11px; color: #b0bec5; margin-top: 50px; }
    </style>
</head>
<body>

<header>
    <img src="image_1.png" class="logo-clipart" alt="ì²­ê°œêµ¬ë¦¬ ë¡œê³ " onerror="this.style.display='none';"> 
    <h1 class="main-title">ì²­ê°œêµ¬ë¦¬ ì°½í˜¸ê²¬ì </h1>
    <span class="ver-badge">Ver 15.0 Pro</span>
</header>

<div class="container" id="captureArea">
    
    <div class="intro-disclaimer">
        <div class="intro-icon">ğŸ’¡</div>
        <p class="intro-text">
            ë³¸ ë¬´ë£Œ ê²¬ì  ì„œë¹„ìŠ¤ëŠ” ì¤‘ê°œ ìˆ˜ìˆ˜ë£Œ ì—†ì´ <span class="intro-highlight">ìƒì‚°ìì™€ ì†Œë¹„ìë¥¼ ì§ì ‘ ì—°ê²°</span>í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.
            í’ˆì§ˆì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©° ë¶ˆí•„ìš”í•œ ìœ í†µ ë§ˆì§„ì„ ì œê±°í•˜ì—¬ ê°€ì¥ í•©ë¦¬ì ì¸ ê°€ê²©ì„ ì œê³µí•©ë‹ˆë‹¤.
        </p>
    </div>

    <div class="address-row">
        <input type="text" id="aptAddress" placeholder="ì•„íŒŒíŠ¸/ê±´ë¬¼ëª… ê²€ìƒ‰ (í„°ì¹˜)" readonly onclick="openAddressSearch()">
        <button class="btn-search" onclick="openAddressSearch()">ğŸ”</button>
    </div>
    <input type="text" class="detail-input" id="detailAddress" placeholder="ë™/í˜¸ìˆ˜ ì…ë ¥ (ì„ íƒ)">
    
    <div class="info-row">
        <select id="residenceType" class="info-select">
            <option value="" disabled selected>ì£¼ê±° í˜•íƒœ ì„ íƒ</option>
            <option value="APT">ì•„íŒŒíŠ¸</option>
            <option value="VILLA">ë¹Œë¼/ì—°ë¦½</option>
            <option value="HOUSE">ë‹¨ë…ì£¼íƒ</option>
        </select>
        <select id="pyeongSize" class="info-select">
            <option value="" disabled selected>í‰í˜•ëŒ€ ì„ íƒ</option>
            <option value="20">20í‰í˜•ëŒ€</option>
            <option value="30">30í‰í˜•ëŒ€</option>
            <option value="40">40í‰í˜•ëŒ€</option>
            <option value="50">50í‰í˜• ì´ìƒ</option>
        </select>
    </div>

    <div id="inputListArea"></div>

    <div class="btn-group">
        <button class="btn-main btn-calc" onclick="calculateEstimates()">âœ¨ ë¬´ë£Œ ê²¬ì  ì‚°ì¶œ</button>
        <button class="btn-main btn-save" onclick="saveAsImage()">ğŸ“¸ ê²°ê³¼ í™”ë©´ ì €ì¥</button>
    </div>

    <div class="company-grid" id="companyGrid">
        <div style="grid-column: span 2; text-align:center; padding:20px; color:#999; font-size:13px;">
            ì œíœ´ ì—…ì²´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>
    </div>

    <div class="chart-box" id="resultSection" style="display:none;">
        <div class="chart-header">ğŸ“Š ì—…ì²´ë³„ ìµœì¢… ê²¬ì  ë¹„êµ</div>
        
        <div id="resultAddressDisplay" style="text-align:center; font-weight:bold; color:var(--primary-color); margin-bottom:25px; font-size:15px; line-height:1.4;"></div>
        
        <div class="trust-notice">
            <strong>â€» ê²¬ì  í¬í•¨/ë¶ˆí¬í•¨ ë‚´ì—­ ì•ˆë‚´</strong><br>
            â€¢ <strong>í¬í•¨:</strong> ì°½í˜¸ ìì¬ë¹„, í‘œì¤€ ì‹œê³µë¹„<br>
            â€¢ <strong>ë¶ˆí¬í•¨(ë³„ë„):</strong> ì² ê±°ë¹„, ì‚¬ë‹¤ë¦¬ì°¨(ì–‘ì¤‘ë¹„), ì¸í…Œë¦¬ì–´ ë§ˆê°ë¹„ ë“± í˜„ì¥ íŠ¹ì´ì‚¬í•­<br>
            ìµœì¢… ê¸ˆì•¡ì€ ë‹´ë‹¹ìì˜ ë¬´ë£Œ ë°©ë¬¸ ì‹¤ì¸¡ í›„ ì •í™•í•˜ê²Œ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.
        </div>

        <div id="graphContainer"></div>

        <div id="detailTableContainer"></div>
    </div>
</div>

<footer>
    ì²­ê°œêµ¬ë¦¬ìƒ¤ì‹œ | ê³ ê°ì„¼í„° 1599-7380<br>
    Copyright 2026 All Rights Reserved.
</footer>

<script>
    const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_0fzDiPb7o94pN5PFBWfYpEcm7hqBhUT2Q1RyWqH78WdEnu4rdRSajOi7KN_bVnDUlaXk7TznbJ7o/pub?gid=560833598&single=true&output=csv";

    let companyDB = {};

    // [ì‹ ê·œ] ì—…ì²´ë³„ ì „í™”ë²ˆí˜¸ ë§¤í•‘ ì •ë³´
    const companyPhoneMap = {
        "KCC(ì—ìŠ¤í„°)": "010-7166-8983",
        "KCC(ìœ„ë‹ˆë“œ)": "010-2159-5911",
        "LX(ê±°ì°½)": "010-4664-8282",
        "LX(ìœ„ë‹ˆë“œ)": "010-2159-5911",
        "LX(ì‹ ì°½)": "010-2616-8014",
        "í˜„ëŒ€(ìœ„ë‹ˆë“œ)": "010-2159-5911"
    };

    async function fetchPriceData() {
        try {
            const response = await fetch(GOOGLE_SHEET_CSV_URL);
            if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
            const text = await response.text();
            parseCSV(text);
        } catch (error) {
            console.error("ë¡œë”© ì‹¤íŒ¨:", error);
            document.getElementById('companyGrid').innerHTML = "<div style='grid-column: span 2; text-align:center; padding:20px;'>ì—…ì²´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>";
        }
    }

    function parseSmartCSV(text) {
        const rows = [];
        let currentRow = [];
        let currentCell = '';
        let insideQuotes = false;
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];
            if (char === '"') {
                if (insideQuotes && nextChar === '"') { currentCell += '"'; i++; }
                else { insideQuotes = !insideQuotes; }
            } else if (char === ',' && !insideQuotes) {
                currentRow.push(currentCell.trim()); currentCell = '';
            } else if ((char === '\r' || char === '\n') && !insideQuotes) {
                if (char === '\r' && nextChar === '\n') i++;
                if (currentCell || currentRow.length > 0) currentRow.push(currentCell.trim());
                if (currentRow.length > 0) rows.push(currentRow);
                currentRow = []; currentCell = '';
            } else { currentCell += char; }
        }
        if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
        return rows;
    }

    function parseCSV(csvText) {
        const rows = parseSmartCSV(csvText);
        const newDB = {};
        
        rows.forEach((row, index) => {
            if (index === 0) return; 
            if (row.length < 5) return; 

            const code = row[0];        
            const comp = row[2];        
            const itemName = row[5] || ""; 
            const itemSpec = row[6] || ""; 
            
            let priceRaw = row[8] || "0"; 
            priceRaw = priceRaw.replace(/,/g, '').replace(/"/g, '');
            const price = parseInt(priceRaw);

            if (code && comp && !isNaN(price)) {
                if (!newDB[comp]) newDB[comp] = { name: comp, specs: {} };
                newDB[comp].specs[code] = { price: price, name: itemName, desc: itemSpec };
            }
        });

        if (Object.keys(newDB).length > 0) {
            companyDB = newDB;
            console.log("âœ… ë‹¨ê°€í‘œ ì—°ë™ ì™„ë£Œ");
            renderInitialButtons(); 
        }
    }
    
    // [ì‹ ê·œ] ì „í™” ê±¸ê¸° í•¨ìˆ˜
    function callCompany(compName) {
        const phone = companyPhoneMap[compName];
        if (phone) {
            // ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ì „í™” ì•± ì‹¤í–‰
            if(confirm(`'${compName}' ë‹´ë‹¹ìì—ê²Œ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ğŸ“ ${phone})`)) {
                window.location.href = `tel:${phone}`;
            }
        } else {
            alert("í•´ë‹¹ ì—…ì²´ì˜ ì „í™”ë²ˆí˜¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    // [ìˆ˜ì •] ì´ˆê¸° ë²„íŠ¼ ë Œë”ë§ (ì „í™” ì—°ê²° ê¸°ëŠ¥ ì¶”ê°€)
    function renderInitialButtons() {
        const grid = document.getElementById('companyGrid');
        grid.innerHTML = ""; 
        const companies = Object.keys(companyDB);
        
        companies.forEach((compName, idx) => {
            const colorIdx = (idx % 6) + 1;
            // onclick ì´ë²¤íŠ¸ì— callCompany í•¨ìˆ˜ ì—°ê²° ë° ì „í™” ì•„ì´ì½˜ ì¶”ê°€
            grid.innerHTML += `
                <button class="comp-btn cb-${colorIdx}" onclick="callCompany('${compName}')">
                    <span>${compName}</span>
                    <span class="phone-icon">ğŸ“</span>
                </button>
            `;
        });
    }

    fetchPriceData();

    function openAddressSearch() {
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = data.roadAddress || data.jibunAddress;
                if(data.buildingName) addr += " (" + data.buildingName + ")";
                document.getElementById("aptAddress").value = addr;
            }
        }).open();
    }

    const defaultLocations = [
        "ê±°ì‹¤", "ì•ˆë°©", "ì¹¨ì‹¤1", "ì¹¨ì‹¤2", "ì¹¨ì‹¤3", "ì¹¨ì‹¤4", 
        "ë°œì½”ë‹ˆ1", "ë°œì½”ë‹ˆ2", "ì„¸íƒì‹¤", "ì£¼ë°©", "ì¤‘ë¬¸"
    ];
    
    const inputArea = document.getElementById('inputListArea');
    const windowOptions = `
        <option value="S_IN">ë‹¨ì°½ë‚´ë¶€ìš©</option>
        <option value="S_BAL">ë‹¨ì°½ì™¸ë¶€ìš©</option>
        <option value="D_IN">ì´ì¤‘ì°½ë‚´ë¶€ìš©</option>
        <option value="D_EXT">ì´ì¤‘ì°½ì™¸ë¶€ìš©</option>
        <option value="SYS">ë¶„í•©ì°½ë‚´ë¶€ìš©</option>
        <option value="TURNING">ì¤‘ë¬¸</option>
        <option value="PJ">ë£¨ë²„ì°½</option>
    `;

    defaultLocations.forEach((loc, index) => {
        let defaultType = "D_IN";
        if (loc.includes("ì¤‘ë¬¸")) defaultType = "TURNING";
        else if (loc.includes("ë°œì½”ë‹ˆ") || loc.includes("ì„¸íƒì‹¤")) defaultType = "S_BAL";
        else if (loc.includes("ê±°ì‹¤")) defaultType = "S_BAL";
        
        const currentOptions = windowOptions.replace(`value="${defaultType}"`, `value="${defaultType}" selected`);

        const locSelectOptions = defaultLocations.map(opt => 
            `<option value="${opt}" ${opt === loc ? 'selected' : ''}>${opt}</option>`
        ).join('');

        const html = `
            <div class="input-card">
                <div class="loading-overlay" id="loading_${index}">
                    <div class="spinner"></div>
                    <span style="font-size:11px; margin-top:5px; font-weight:bold;">AI ë¶„ì„ì¤‘..</span>
                </div>
                <div class="photo-area">
                    <div class="camera-icon" id="icon_${index}">ğŸ“·</div>
                    <div class="photo-hint" id="hint_${index}">ì‚¬ì§„ì´¬ì˜<br>(A4ë¶€ì°©)</div>
                    <img id="preview_${index}">
                    <input type="file" accept="image/*" class="photo-input-hidden" onchange="window.handleImageUpload(this, ${index})">
                </div>
                <div class="dim-area">
                    <div class="row-head">
                        <div>
                            <span class="row-number">No.${index + 1}</span>
                            <select id="loc_${index}" class="loc-select" onchange="autoSelectType(this, ${index})">
                                ${locSelectOptions}
                            </select>
                        </div>
                        <div class="badge-ai" id="badge_${index}">ì™„ë£Œ</div>
                    </div>
                    <select id="type_${index}">${currentOptions}</select>
                    <div class="size-inputs">
                        <input type="number" id="w_${index}" placeholder="ê°€ë¡œ mm" inputmode="numeric">
                        <input type="number" id="h_${index}" placeholder="ì„¸ë¡œ mm" inputmode="numeric">
                    </div>
                </div>
            </div>
        `;
        inputArea.innerHTML += html;
    });

    window.autoSelectType = function(selectElem, index) {
        const loc = selectElem.value;
        const typeSelect = document.getElementById(`type_${index}`);
        
        if(loc.includes("ì¤‘ë¬¸")) typeSelect.value = "TURNING";
        else if(loc.includes("ë°œì½”ë‹ˆ") || loc.includes("ì„¸íƒì‹¤")) typeSelect.value = "S_BAL";
        else if(loc.includes("ê±°ì‹¤")) typeSelect.value = "S_BAL"; 
        else typeSelect.value = "D_IN"; 
    };

    function calculateEstimates() {
        const resType = document.getElementById("residenceType").value;
        const pyeong = document.getElementById("pyeongSize").value;

        if(!resType) { alert("ì£¼ê±° í˜•íƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); document.getElementById("residenceType").focus(); return; }
        if(!pyeong) { alert("í‰í˜•ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); document.getElementById("pyeongSize").focus(); return; }

        let hasData = false;
        let reqList = [];

        const fullAddr = document.getElementById('aptAddress').value + " " + document.getElementById('detailAddress').value;
        const addrDisplay = document.getElementById('resultAddressDisplay');
        
        if(fullAddr.trim().length > 1) {
            const resText = document.getElementById("residenceType").options[document.getElementById("residenceType").selectedIndex].text;
            const pyeongText = document.getElementById("pyeongSize").options[document.getElementById("pyeongSize").selectedIndex].text;
            addrDisplay.innerHTML = `ğŸ“ ${fullAddr}<br><span style="font-size:14px; color:#555; font-weight:normal;">[${resText} / ${pyeongText}]</span>`;
        }

        for(let i=0; i<11; i++) { 
            const w = parseFloat(document.getElementById(`w_${i}`).value) || 0;
            const h = parseFloat(document.getElementById(`h_${i}`).value) || 0;
            const type = document.getElementById(`type_${i}`).value;
            const locName = document.getElementById(`loc_${i}`).value;

            if (w > 0 && h > 0) {
                let qty = (type === "TURNING") ? 1 : (w * h) / 90000;
                reqList.push({ loc: locName, type: type, w: w, h: h, qty: qty });
                hasData = true;
            }
        }

        if (!hasData) { alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ì°½í˜¸ ì¹˜ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        if (Object.keys(companyDB).length === 0) { alert("âŒ ê²¬ì  ë°ì´í„° ë¡œë”© ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."); return; }

        let results = [];
        for (const [compName, data] of Object.entries(companyDB)) {
            let sum = 0;
            reqList.forEach(item => {
                const specData = data.specs[item.type];
                if (specData) {
                    sum += specData.price * item.qty;
                }
            });
            if (sum > 0) results.push({ name: compName, cost: Math.floor(sum) });
        }

        const resultBox = document.getElementById('resultSection');
        const container = document.getElementById('graphContainer');
        const companyGrid = document.getElementById('companyGrid'); 
        const detailContainer = document.getElementById('detailTableContainer');
        
        resultBox.style.display = 'block';
        container.innerHTML = "";
        companyGrid.innerHTML = ""; 

        results.sort((a, b) => a.cost - b.cost);
        
        if(results.length > 0) {
            const maxCost = results[results.length - 1].cost;
            let btnHtml = ""; 

            results.forEach((item, idx) => {
                const percent = (item.cost / maxCost) * 100;
                const barClass = idx === 0 ? 'g-bar best' : (idx === 1 ? 'g-bar second' : 'g-bar');
                
                let badge = "";
                if(idx === 0) badge = "<div class='badge-best'>ìµœì €ê°€</div>";

                container.innerHTML += `
                    <div class="graph-row">
                        <div class="g-label">${item.name}</div>
                        <div class="g-bar-bg">
                            <div class="${barClass}" style="width:${percent}%"></div>
                            ${badge}
                        </div>
                        <div class="g-price">${(item.cost/10000).toFixed(0)}ë§Œì›</div>
                    </div>`;
                
                // [ìˆ˜ì •] ê°€ê²©ìˆœ ì •ë ¬ëœ ë²„íŠ¼ ì¬ìƒì„± (ì „í™” ì—°ê²° ê¸°ëŠ¥ í¬í•¨)
                const colorIdx = (idx % 6) + 1;
                btnHtml += `
                    <button class="comp-btn cb-${colorIdx}" onclick="callCompany('${item.name}')">
                        <span>${item.name}</span>
                        <span class="phone-icon">ğŸ“</span>
                    </button>
                `;
            });
            
            companyGrid.innerHTML = btnHtml;

            let allDetailsHtml = "";
            results.forEach(companyRes => {
                const compName = companyRes.name;
                const compData = companyDB[compName];
                
                allDetailsHtml += `
                    <div class="d-title">ğŸ“‘ ${compName} ìƒì„¸ ê²¬ì ì„œ <span style="font-size:12px; font-weight:normal; margin-left:auto;">(ë‹¨ìœ„:ì›)</span></div>
                    <table class="d-table">
                        <thead>
                            <tr>
                                <th width="18%">ìœ„ì¹˜</th>
                                <th width="25%">ê·œê²©(mm)</th>
                                <th>ìŠ¤í™</th>
                                <th width="22%">ê¸ˆì•¡</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let totalSum = 0;
                reqList.forEach(item => {
                    const specInfo = compData.specs[item.type];
                    let price = 0;
                    let specText = "-";
                    
                    if (specInfo) {
                        price = Math.floor(specInfo.price * item.qty);
                        specText = specInfo.name;
                    } else {
                        specText = "<span style='color:#d32f2f;'>ë‹¨ê°€ì—†ìŒ</span>";
                    }
                    
                    allDetailsHtml += `
                        <tr>
                            <td>${item.loc}</td>
                            <td>${item.w} x ${item.h}</td>
                            <td class="left">${specText}</td>
                            <td style="font-weight:700;">${price.toLocaleString()}</td>
                        </tr>
                    `;
                    totalSum += price;
                });
                
                allDetailsHtml += `
                            <tr class="total-row">
                                <td colspan="3">ì´ ê²¬ì  í•©ê³„</td>
                                <td class="total-price">${totalSum.toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            });

            allDetailsHtml += `
                <div class="estimate-note">
                    â€» ìœ„ ê²¬ì ì€ ì¸ê³µì§€ëŠ¥(AI) ê¸°ë°˜ì˜ ì˜ˆìƒ ê²¬ì ì…ë‹ˆë‹¤. ì •í™•í•œ ê¸ˆì•¡ì€ í˜„ì¥ ì‹¤ì¸¡ ë° ì˜µì…˜ ì„ íƒì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            `;

            detailContainer.innerHTML = allDetailsHtml;

        } else {
            container.innerHTML += "<div style='text-align:center; padding:20px;'>ì‚°ì¶œëœ ê²¬ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
        }
        
        resultBox.scrollIntoView({behavior: "smooth", block: "start"});
    }

    function saveAsImage() {
        window.scrollTo(0,0);
        setTimeout(() => {
            html2canvas(document.querySelector("#captureArea"), {scale: 2}).then(canvas => {
                const link = document.createElement('a');
                link.download = 'ì²­ê°œêµ¬ë¦¬_ì „ë¬¸ê²¬ì ì„œ.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }, 300);
    }
</script>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    const p1 = "AIzaSyAq7G2mE2qFuUi";
    const p2 = "f-";
    const p3 = "PgPDsXl1ppbY5_JK54";
    const API_KEY = p1 + p2 + p3;

    window.handleImageUpload = async function(inputElement, index) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById(`icon_${index}`).style.display = 'none';
            document.getElementById(`hint_${index}`).style.display = 'none';
            const img = document.getElementById(`preview_${index}`);
            img.src = e.target.result;
            img.style.display = 'block';
        }
        reader.readAsDataURL(file);

        const loading = document.getElementById(`loading_${index}`);
        loading.style.display = 'flex';

        try {
            const genAI = new GoogleGenerativeAI(API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });
            
            const imagePart = await fileToGenerativePart(file);
            const locationName = document.getElementById(`loc_${index}`).value;
            
            let parts = [imagePart];
            
            let prompt = `
                ë‹¹ì‹ ì€ ì°½í˜¸ ê²¬ì  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                ì‚¬ì§„ ì† **${locationName}** ì°½ë¬¸ì˜ ì „ì²´ í”„ë ˆì„ í¬ê¸°(mm)ë¥¼ A4ìš©ì§€(210x297mm) ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•˜ì„¸ìš”.
                
                ì‘ë‹µì€ ì˜¤ì§ JSONìœ¼ë¡œë§Œ:
                {
                    "typeCode": "ë¬¸ìì—´ (S_IN, S_BAL, D_IN, D_EXT, SYS, TURNING, PJ ì¤‘ í•˜ë‚˜)",
                    "width": ìˆ«ì (mm),
                    "height": ìˆ«ì (mm)
                }
            `;
            
            parts.unshift(prompt);

            const result = await model.generateContent(parts);
            const response = await result.response;
            const text = response.text().replace(/```json|```/g, "").trim();
            const data = JSON.parse(text);

            if(data.typeCode) document.getElementById(`type_${index}`).value = data.typeCode;
            if(data.width) document.getElementById(`w_${index}`).value = data.width;
            if(data.height) document.getElementById(`h_${index}`).value = data.height;
            document.getElementById(`badge_${index}`).style.display = 'block';

        } catch (error) {
            console.error(error);
            alert("AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¹˜ìˆ˜ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        } finally {
            loading.style.display = 'none';
        }
    };

    async function fileToGenerativePart(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64Data = reader.result.split(',')[1];
                resolve({ inlineData: { data: base64Data, mimeType: file.type } });
            };
            reader.readAsDataURL(file);
        });
    }
</script>

</body>
</html>
