<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²­ê°œêµ¬ë¦¬ ì°½í˜¸ê²¬ì (ë¬´ë£Œ)</title>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        :root { --primary-color: #1a73e8; --bg-color: #f0f4f8; --card-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: #333; -webkit-font-smoothing: antialiased; }

        /* [ìˆ˜ì •ë¨] í—¤ë” ìŠ¤íƒ€ì¼: í™”ë©´ ìµœìƒë‹¨ ê³ ì • */
        header { 
            background: linear-gradient(100deg, #4285f4 0%, #0d47a1 100%); 
            padding: 0 15px; 
            height: 60px; 
            display: flex; 
            align-items: center; 
            /* position: sticky; ë¥¼ fixedë¡œ ë³€ê²½í•˜ì—¬ ë¬´ì¡°ê±´ ë§¨ ìœ„ì— ê³ ì • */
            position: fixed; 
            top: 0; 
            left: 0;
            width: 100%; /* ì „ì²´ ë„ˆë¹„ ì‚¬ìš© */
            z-index: 100; 
            color: white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            box-sizing: border-box; /* íŒ¨ë”©ì´ ë„ˆë¹„ì— í¬í•¨ë˜ë„ë¡ */
        }
        .logo-clipart { width: 40px; height: 40px; background: rgba(255,255,255,0.95); border-radius: 8px; padding: 2px; margin-right: 10px; }
        .header-content { flex: 1; display: flex; justify-content: space-between; align-items: center; }
        .main-title { margin: 0; font-size: 18px; font-weight: 800; }
        .ver-badge { font-size: 10px; background: #00C73C; color: #fff; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

        /* [ìˆ˜ì •ë¨] ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼: ìƒë‹¨ ì—¬ë°± ì¶”ê°€ */
        .container { 
            max-width: 768px; 
            margin: 0 auto; 
            padding: 15px; 
            /* í—¤ë” ë†’ì´(60px) + ê¸°ë³¸ íŒ¨ë”©(15px) ë§Œí¼ ìƒë‹¨ ì—¬ë°± í™•ë³´ */
            padding-top: 75px; 
            padding-bottom: 100px; 
        }

        /* ì£¼ì†Œ ë° ë„ë©´ ì„¹ì…˜ */
        .top-section { background: white; border-radius: 12px; padding: 15px; box-shadow: var(--card-shadow); margin-bottom: 15px; }
        .address-row { display: flex; gap: 5px; margin-bottom: 8px; }
        .address-row input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; font-weight: bold; }
        .btn-search { background: #333; color: white; border: none; padding: 0 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .detail-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; margin-bottom: 8px;}
        
        /* ë„¤ì´ë²„ ë²„íŠ¼ */
        .btn-naver { width: 100%; background: #03C75A; color: white; border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 10px; }
        
        /* ë„ë©´ ì—…ë¡œë“œ ì˜ì—­ */
        .blueprint-area { border: 2px dashed #03C75A; border-radius: 8px; padding: 10px; text-align: center; position: relative; background: #f0fdf4; cursor: pointer; }
        .blueprint-text { font-size: 12px; color: #2e7d32; font-weight: bold; }
        .blueprint-preview { max-height: 150px; display: none; margin: 0 auto; border-radius: 4px; margin-top: 5px; border: 1px solid #ddd; }
        .file-hidden { position: absolute; top:0; left:0; width:100%; height:100%; opacity: 0; cursor: pointer; }

        /* ì…ë ¥ ì¹´ë“œ (ìŠ¬ë¦¼í˜• ë””ìì¸ ì ìš©) */
        .input-card { 
            background: white; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 10px; 
            display: flex; flex-direction: row; height: 140px; overflow: hidden; border: 1px solid #eee;
        }
        
        /* ì¢Œì¸¡: ì‚¬ì§„ ì˜ì—­ (40%) */
        .photo-area { 
            width: 40%; background: #f1f3f5; position: relative; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-right: 1px solid #eee;
        }
        .photo-area img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .camera-icon { font-size: 24px; margin-bottom: 5px; }
        .photo-hint { font-size: 11px; color: #666; text-align: center; line-height: 1.2; }
        .photo-hint strong { color: #e53935; }

        /* ìš°ì¸¡: ì…ë ¥ ì˜ì—­ (60%) */
        .dim-area { width: 60%; padding: 10px; display: flex; flex-direction: column; justify-content: center; gap: 6px; }
        .row-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .row-title { font-size: 15px; font-weight: 800; color: var(--primary-color); }
        .badge-ai { font-size: 10px; background: #e3f2fd; color: #1565c0; padding: 2px 4px; border-radius: 3px; display: none; }
        
        select, input[type="number"] { 
            width: 100%; height: 32px; border: 1px solid #ddd; border-radius: 5px; 
            font-size: 13px; padding-left: 5px; box-sizing: border-box; background: #fff;
        }
        .size-inputs { display: flex; gap: 5px; }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 10;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner { width: 20px; height: 20px; border: 3px solid #ddd; border-top: 3px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* í•˜ë‹¨ ë²„íŠ¼ ë° ê²°ê³¼ */
        .btn-group { display: flex; gap: 8px; margin-top: 20px; }
        .btn-main { flex: 1; padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 15px; }
        .btn-calc { background: var(--primary-color); }
        .btn-save { background: #ff9800; }

        .chart-box { background: white; padding: 15px; border-radius: 12px; margin-top: 20px; display: none; }
        .graph-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 12px; }
        .g-label { width: 40px; font-weight: bold; }
        .g-bar-bg { flex: 1; height: 20px; background: #f0f0f0; margin: 0 10px; border-radius: 4px; overflow: hidden; }
        .g-bar { height: 100%; background: #90a4ae; width: 0%; transition: width 1s; }
        .g-bar.best { background: #ff7043; }
        .g-price { width: 70px; text-align: right; font-weight: bold; }

        footer { text-align: center; font-size: 11px; color: #999; margin-top: 30px; padding-bottom: 20px; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; width:100%;">
        <img src="logo.png" class="logo-clipart" onerror="this.style.background='#eee'">
        <div class="header-content">
            <h1 class="main-title">ì²­ê°œêµ¬ë¦¬ ì°½í˜¸ê²¬ì </h1>
            <span class="ver-badge">Ver 10.2 Fixed Header</span>
        </div>
    </div>
</header>

<div class="container" id="captureArea">
    
    <div class="top-section">
        <div class="address-row">
            <input type="text" id="aptAddress" placeholder="ì•„íŒŒíŠ¸ëª… ê²€ìƒ‰ (ì˜ˆ: ì€ë§ˆì•„íŒŒíŠ¸)" readonly onclick="openAddressSearch()">
            <button class="btn-search" onclick="openAddressSearch()">ğŸ”</button>
        </div>
        <input type="text" class="detail-input" id="detailAddress" placeholder="ë™/í˜¸ìˆ˜ ì…ë ¥">
        
        <button class="btn-naver" onclick="searchNaverLand()">
            <span>N</span> ë„¤ì´ë²„ ë¶€ë™ì‚°ì—ì„œ ë„ë©´ ì°¾ê¸°
        </button>

        <div class="blueprint-area">
            <div class="blueprint-text">ğŸ“¸ ìœ„ì—ì„œ ì°¾ì€ <strong>ë„ë©´ì„ ìº¡ì²˜</strong>í•´ì„œ ì˜¬ë ¤ì£¼ì„¸ìš”! (ì˜¤ì°¨ 0mm)</div>
            <img id="blueprintPreview" class="blueprint-preview">
            <input type="file" accept="image/*" class="file-hidden" onchange="handleBlueprintUpload(this)">
        </div>
    </div>

    <div id="inputListArea"></div>

    <div class="btn-group">
        <button class="btn-main btn-calc" onclick="calculateEstimates()">âœ¨ ê²¬ì  ì‚°ì¶œ</button>
        <button class="btn-main btn-save" onclick="saveAsImage()">ğŸ“¸ ì €ì¥</button>
    </div>

    <div class="chart-box" id="resultSection">
        <h3 style="margin:0 0 15px 0; text-align:center;">ğŸ“Š ì—…ì²´ë³„ ì˜ˆìƒ ê²¬ì </h3>
        <div id="graphContainer"></div>
    </div>
</div>

<footer>
    ì²­ê°œêµ¬ë¦¬ìƒ¤ì‹œ | ê³ ê°ì„¼í„° 1599-7380<br>
    Copyright 2026 All Rights Reserved.
</footer>

<script>
    // ì „ì—­ ë³€ìˆ˜: ë„ë©´ íŒŒì¼
    let globalBlueprintFile = null;

    // 1. ì£¼ì†Œ ì°¾ê¸°
    function openAddressSearch() {
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = data.roadAddress || data.jibunAddress;
                if(data.buildingName) addr += " (" + data.buildingName + ")";
                document.getElementById("aptAddress").value = addr;
            }
        }).open();
    }

    // 2. [NEW] ë„¤ì´ë²„ ë¶€ë™ì‚° ê²€ìƒ‰ ê¸°ëŠ¥
    function searchNaverLand() {
        const addr = document.getElementById("aptAddress").value;
        if (!addr) {
            alert("ë¨¼ì € ì£¼ì†Œë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”!");
            return;
        }
        // ì£¼ì†Œì—ì„œ í•µì‹¬ í‚¤ì›Œë“œ(ì•„íŒŒíŠ¸ëª…)ë§Œ ì¶”ì¶œí•´ì„œ ê²€ìƒ‰
        const query = addr.split("(")[0].trim(); 
        const url = `https://m.land.naver.com/search/result/${encodeURIComponent(query)}`;
        window.open(url, '_blank');
        alert("ë„¤ì´ë²„ ë¶€ë™ì‚°ì´ ì—´ë¦¬ë©´ 'ë‹¨ì§€ì •ë³´ > í‰ë©´ë„'ë¥¼ ìº¡ì²˜í•´ì„œ ë“±ë¡í•´ì£¼ì„¸ìš”.");
    }

    // 3. ë„ë©´ ì—…ë¡œë“œ ì²˜ë¦¬
    function handleBlueprintUpload(input) {
        if (input.files && input.files[0]) {
            globalBlueprintFile = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('blueprintPreview');
                img.src = e.target.result;
                img.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 4. ì…ë ¥ ì¹´ë“œ ìƒì„± (ìŠ¬ë¦¼ ë ˆì´ì•„ì›ƒ)
    const locations = ["ê±°ì‹¤", "ì•ˆë°©", "ì¹¨ì‹¤1", "ì¹¨ì‹¤2", "ì¹¨ì‹¤3", "ì£¼ë°©", "ë°œì½”ë‹ˆ1", "ë°œì½”ë‹ˆ2", "í„°ë‹ë„ì–´"];
    const inputArea = document.getElementById('inputListArea');
    const windowOptions = `
        <option value="S_IN">ë‚´ë¶€ìš© ë‹¨ì°½ (ë°©ì°½)</option>
        <option value="S_BAL">ë°œì½”ë‹ˆìš© ë‹¨ì°½ (ì™¸ë¶€)</option>
        <option value="D_IN">ë‚´ë¶€ìš© ì´ì¤‘ì°½</option>
        <option value="D_EXT">í™•ì¥í˜• ì´ì¤‘ì°½ (ë‹¨ì—´â†‘)</option>
        <option value="SYS">ì‹œìŠ¤í…œì°½ / í„°ë‹ë„ì–´</option>
        <option value="PJ">PJì°½ / í”„ë¡œì íŠ¸ì°½</option>
    `;

    locations.forEach((loc, index) => {
        const html = `
            <div class="input-card">
                <div class="loading-overlay" id="loading_${index}">
                    <div class="spinner"></div>
                    <span style="font-size:11px; margin-top:5px; font-weight:bold;">ë¶„ì„ì¤‘..</span>
                </div>
                
                <div class="photo-area">
                    <div class="camera-icon" id="icon_${index}">ğŸ“·</div>
                    <div class="photo-hint" id="hint_${index}">ì‚¬ì§„ì´¬ì˜<br><strong>(A4ë¶€ì°©)</strong></div>
                    <img id="preview_${index}">
                    <input type="file" accept="image/*" class="file-hidden" onchange="window.handleImageUpload(this, ${index})">
                </div>

                <div class="dim-area">
                    <div class="row-head">
                        <div class="row-title">NO.${index + 1} ${loc}</div>
                        <div class="badge-ai" id="badge_${index}">AI ì™„ë£Œ</div>
                    </div>
                    <input type="hidden" id="loc_${index}" value="${loc}">
                    <select id="type_${index}">${windowOptions}</select>
                    <div class="size-inputs">
                        <input type="number" id="w_${index}" placeholder="ê°€ë¡œ mm">
                        <input type="number" id="h_${index}" placeholder="ì„¸ë¡œ mm">
                    </div>
                </div>
            </div>
        `;
        inputArea.innerHTML += html;
    });

    // 5. ê²¬ì  ê³„ì‚° ë° ê·¸ë˜í”„
    const companyDB = {
        'Aì‚¬': { name: 'Aì‚¬', price: 100 }, 'Bì‚¬': { name: 'Bì‚¬', price: 90 }, 'Cì‚¬': { name: 'Cì‚¬', price: 120 },
        'Dì‚¬': { name: 'Dì‚¬', price: 95 }, 'Eì‚¬': { name: 'Eì‚¬', price: 105 }, 'Fì‚¬': { name: 'Fì‚¬', price: 110 }
    };

    function calculateEstimates() {
        let totalPyeong = 0;
        let hasData = false;

        for(let i=0; i<9; i++) {
            const w = parseFloat(document.getElementById(`w_${i}`).value) || 0;
            const h = parseFloat(document.getElementById(`h_${i}`).value) || 0;
            if (w > 0 && h > 0) {
                totalPyeong += (w * h) / 90000; 
                hasData = true;
            }
        }

        if (!hasData) { alert("ì¹˜ìˆ˜ë¥¼ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

        const resultBox = document.getElementById('resultSection');
        const container = document.getElementById('graphContainer');
        resultBox.style.display = 'block';
        container.innerHTML = '';

        let results = [];
        for (const [key, val] of Object.entries(companyDB)) {
            // ë‹¨ìˆœ ì˜ˆì‹œ ê³„ì‚°ì‹ (ì‹¤ì œ ë¡œì§ì€ ë³µì¡í•  ìˆ˜ ìˆìŒ)
            const cost = Math.floor(1000000 + (totalPyeong * 10000 * val.price / 100));
            results.push({ name: val.name, cost: cost });
        }
        results.sort((a, b) => a.cost - b.cost);
        const maxCost = results[results.length - 1].cost;

        results.forEach((item, idx) => {
            const percent = (item.cost / maxCost) * 100;
            const barClass = idx === 0 ? 'g-bar best' : (idx === 1 ? 'g-bar second' : 'g-bar');
            
            const html = `
                <div class="graph-row">
                    <div class="g-label">${item.name}</div>
                    <div class="g-bar-bg"><div class="${barClass}" style="width:${percent}%"></div></div>
                    <div class="g-price">${(item.cost/10000).toFixed(0)}ë§Œ</div>
                </div>
            `;
            container.innerHTML += html;
        });
        
        resultBox.scrollIntoView({behavior: "smooth"});
    }

    function saveAsImage() {
        html2canvas(document.body).then(canvas => {
            const link = document.createElement('a');
            link.download = 'ê²¬ì ê²°ê³¼.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    const p1 = "AIzaSyAq7G2mE2qFuUi";
    const p2 = "f-";
    const p3 = "PgPDsXl1ppbY5_JK54";
    const API_KEY = p1 + p2 + p3;

    window.handleImageUpload = async function(inputElement, index) {
        const file = inputElement.files[0];
        if (!file) return;

        // ë¯¸ë¦¬ë³´ê¸°
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById(`icon_${index}`).style.display = 'none';
            document.getElementById(`hint_${index}`).style.display = 'none';
            const img = document.getElementById(`preview_${index}`);
            img.src = e.target.result;
            img.style.display = 'block';
        }
        reader.readAsDataURL(file);

        // ë¡œë”© ì‹œì‘
        const loading = document.getElementById(`loading_${index}`);
        loading.style.display = 'flex';

        try {
            const genAI = new GoogleGenerativeAI(API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });
            
            const imagePart = await fileToGenerativePart(file);
            const locationName = document.getElementById(`loc_${index}`).value;
            
            let parts = [imagePart];
            let prompt = "";

            if (window.globalBlueprintFile) {
                // ë„ë©´ì´ ìˆëŠ” ê²½ìš°
                const blueprintPart = await fileToGenerativePart(window.globalBlueprintFile);
                parts.push(blueprintPart);
                prompt = `
                    ë‹¹ì‹ ì€ ì°½í˜¸ ê²¬ì  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                    ì´ë¯¸ì§€1: í˜„ì¥(${locationName}) ì‚¬ì§„ (A4ìš©ì§€ ë¶€ì°©ë¨)
                    ì´ë¯¸ì§€2: ì•„íŒŒíŠ¸ í‰ë©´ë„(ë„ë©´)

                    [ì„ë¬´]
                    1. ë„ë©´ì—ì„œ **${locationName}**ì˜ ìœ„ì¹˜ë¥¼ ì°¾ì•„ ì í˜€ìˆëŠ” ì¹˜ìˆ˜(ê°€ë¡œxì„¸ë¡œ)ë¥¼ ì½ìœ¼ì„¸ìš”.
                    2. ë„ë©´ ìˆ˜ì¹˜ê°€ ì‹ë³„ë˜ë©´ ê·¸ê²ƒì„ ìš°ì„  ì ìš©í•˜ì„¸ìš”.
                    3. ì‹ë³„ì´ ì•ˆë˜ë©´, í˜„ì¥ ì‚¬ì§„ ì† A4ìš©ì§€(210x297mm)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ì°½í‹€ í¬ê¸°ë¥¼ ê³„ì‚°í•˜ì„¸ìš”.
                    4. ê±°ì‹¤ì´ë‚˜ ì•ˆë°©ì€ ì°½ë¬¸ í•˜ë‚˜ê°€ ì•„ë‹ˆë¼ **ì „ì²´ ë²½ë©´ ë„ˆë¹„**ë¥¼ ê³„ì‚°í•´ì•¼ í•©ë‹ˆë‹¤.
                `;
            } else {
                // ì‚¬ì§„ë§Œ ìˆëŠ” ê²½ìš°
                prompt = `
                    ë‹¹ì‹ ì€ ì°½í˜¸ ê²¬ì  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                    ì‚¬ì§„ ì† **${locationName}** ì°½ë¬¸ì˜ ì „ì²´ í‹€ í¬ê¸°(ê°€ë¡œxì„¸ë¡œ)ë¥¼ A4ìš©ì§€(210x297mm) ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•˜ì„¸ìš”.
                    
                    [ë³´ì • ê·œì¹™]
                    - ê±°ì‹¤: 3000mm ë¯¸ë§Œì´ë©´ ì°½ë¬¸ í•œ ì§ë§Œ ì°íŒ ê²ƒì´ë‹ˆ í•œêµ­ ì•„íŒŒíŠ¸ í‘œì¤€(3600~4500mm)ìœ¼ë¡œ ë³´ì •í•˜ì„¸ìš”.
                    - ì•ˆë°©/ì¹¨ì‹¤: ë†’ì´ê°€ 1800~2000mmë©´ ë°œì½”ë‹ˆì°½ì´ë¯€ë¡œ 2200~2300mmë¡œ ë³´ì •í•˜ì„¸ìš”.
                    - ë¸”ë¼ì¸ë“œ: ìƒë‹¨ì— ìˆìœ¼ë©´ ë†’ì´ +200mm í•˜ì„¸ìš”.
                `;
            }

            prompt += ` ì˜¤ì§ JSONìœ¼ë¡œ ë‹µí•˜ì„¸ìš”: {"typeCode": "S_BAL" ë“±, "width": ìˆ«ì, "height": ìˆ«ì}`;
            parts.unshift(prompt);

            const result = await model.generateContent(parts);
            const response = await result.response;
            const text = response.text().replace(/```json|```/g, "").trim();
            const data = JSON.parse(text);

            document.getElementById(`type_${index}`).value = data.typeCode;
            document.getElementById(`w_${index}`).value = data.width;
            document.getElementById(`h_${index}`).value = data.height;
            document.getElementById(`badge_${index}`).style.display = 'block';

        } catch (error) {
            console.error(error);
            alert("AI ë¶„ì„ ì‹¤íŒ¨. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        } finally {
            loading.style.display = 'none';
        }
    };

    async function fileToGenerativePart(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64Data = reader.result.split(',')[1];
                resolve({ inlineData: { data: base64Data, mimeType: file.type } });
            };
            reader.readAsDataURL(file);
        });
    }
</script>

</body>
</html>
