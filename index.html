<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²­ê°œêµ¬ë¦¬ ì°½í˜¸ê²¬ì (ë¬´ë£Œ)</title>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        :root { --primary-color: #1a73e8; --bg-color: #f0f4f8; --card-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: #333; -webkit-font-smoothing: antialiased; }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header { 
            background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%); 
            padding: 0 15px; height: 60px; display: flex; align-items: center; justify-content: center;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; 
            color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); box-sizing: border-box; 
        }
        
        .logo-clipart { 
            width: 45px; height: 45px; 
            background: rgba(255,255,255,0.95); border-radius: 50%; padding: 2px; 
            position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 2px solid #69F0AE; 
            object-fit: cover; 
        }
        
        .main-title { margin: 0; font-size: 20px; font-weight: 900; text-align: center; letter-spacing: -0.5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .ver-badge { 
            font-size: 9px; background: #00E676; color: #003300; 
            padding: 2px 6px; border-radius: 8px; font-weight: 800; 
            position: absolute; right: 15px; bottom: 8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); letter-spacing: -0.3px;
        }

        .container { max-width: 768px; margin: 0 auto; padding: 15px; padding-top: 80px; padding-bottom: 120px; }

        /* ìƒë‹¨ ì„¹ì…˜ */
        .top-section { background: white; border-radius: 16px; padding: 20px; box-shadow: var(--card-shadow); margin-bottom: 20px; }
        .address-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .address-row input { flex: 1; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; background: #f8f9fa; font-weight: bold; font-size: 14px; }
        .btn-search { background: #37474F; color: white; border: none; padding: 0 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .detail-input { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; margin-bottom: 12px; font-size: 14px; }
        
        .btn-auto-search { 
            width: 100%; background: linear-gradient(90deg, #00C853 0%, #009624 100%); 
            color: white; border: none; padding: 14px; border-radius: 10px; 
            font-size: 16px; font-weight: 800; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            box-shadow: 0 4px 10px rgba(0, 200, 83, 0.3); transition: transform 0.1s; margin-bottom: 15px;
        }
        .btn-auto-search:active { transform: scale(0.98); }

        .alt-links { display: flex; gap: 6px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .blueprint-display-area { 
            border: 2px dashed #b0bec5; border-radius: 12px; 
            min-height: 200px; background: #fafafa; position: relative; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden; cursor: pointer; transition: background 0.2s;
        }
        .bp-placeholder { text-align: center; color: #78909c; pointer-events: none; }
        .bp-img { width: 100%; height: 100%; object-fit: contain; position: absolute; top:0; left:0; display: none; }
        .bp-file-input { position: absolute; width: 100%; height: 100%; top:0; left:0; opacity: 0; cursor: pointer; }
        
        .btn-no-blueprint { display: block; width: 100%; text-align: center; margin-top: 12px; font-size: 12px; color: #ef5350; text-decoration: underline; cursor: pointer; background: none; border: none; }

        /* ì…ë ¥ ì¹´ë“œ */
        .input-card { background: white; border-radius: 16px; box-shadow: var(--card-shadow); margin-bottom: 15px; display: flex; flex-direction: row; height: 150px; overflow: hidden; border: 1px solid #f0f0f0; }
        .photo-area { width: 38%; background: #263238; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
        .photo-area img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .camera-icon { font-size: 28px; margin-bottom: 5px; color: #fff; opacity: 0.8; }
        .photo-hint { font-size: 11px; color: #cfd8dc; text-align: center; line-height: 1.4; }
        .photo-input-hidden { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; left:0; top:0; z-index: 10; }
        
        .dim-area { width: 62%; padding: 15px; display: flex; flex-direction: column; justify-content: center; gap: 8px; }
        
        /* [ìˆ˜ì •] íƒ€ì´í‹€ ì˜ì—­ ìŠ¤íƒ€ì¼: ì…€ë ‰íŠ¸ ë°•ìŠ¤ê°€ ì˜ ì–´ìš¸ë¦¬ë„ë¡ ìˆ˜ì • */
        .row-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .row-number { font-size: 14px; font-weight: 800; color: #1a73e8; margin-right: 4px; }
        /* ìœ„ì¹˜ ì„ íƒ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .loc-select { 
            font-size: 16px; font-weight: 800; color: #37474F; 
            border: none; background: transparent; 
            cursor: pointer; outline: none; padding: 0;
            border-bottom: 1px dashed #cfd8dc;
        }
        .loc-select:focus { border-bottom: 1px solid #1a73e8; }

        .badge-ai { font-size: 10px; background: #e3f2fd; color: #1565c0; padding: 2px 6px; border-radius: 4px; display: none; font-weight: bold; }
        select, input[type="number"] { width: 100%; height: 38px; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 13px; padding-left: 8px; box-sizing: border-box; background: #fff; }
        .size-inputs { display: flex; gap: 6px; }

        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 20; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        .btn-main { flex: 1; padding: 16px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; color: white; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: transform 0.1s; }
        .btn-calc { background: linear-gradient(135deg, #1a73e8 0%, #1565c0 100%); }
        .btn-save { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); }

        /* ê²°ê³¼ì°½ */
        .chart-box { background: white; padding: 20px; border-radius: 16px; margin-top: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); min-height: 120px; display: flex; flex-direction: column; justify-content: center; }
        .chart-placeholder-text { text-align: center; color: #cfd8dc; font-size: 16px; font-weight: 800; padding: 30px 0; }
        
        .graph-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 13px; }
        .g-label { width: 50px; font-weight: 700; color: #455a64; }
        .g-bar-bg { flex: 1; height: 24px; background: #eceff1; margin: 0 12px; border-radius: 6px; overflow: hidden; }
        .g-bar { height: 100%; background: #b0bec5; width: 0%; transition: width 1s ease-out; }
        .g-bar.best { background: #FF7043; } 
        .g-bar.second { background: #42A5F5; } 
        .g-price { width: 80px; text-align: right; font-weight: 800; color: #263238; }

        .estimate-note { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #cfd8dc; font-size: 11px; color: #546e7a; line-height: 1.6; background: #fafafa; border-radius: 8px; padding: 12px; }

        /* ìƒì„¸ ê²¬ì ì„œ í…Œì´ë¸” */
        .detail-table-area { margin-top: 25px; border-top: 2px solid #333; }
        .d-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .d-table th { background: #f5f5f5; padding: 8px; border-bottom: 1px solid #ddd; font-weight: 800; color: #333; text-align: center; }
        .d-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; color: #555; }
        .d-table td.left { text-align: left; }
        .d-title { font-size: 15px; font-weight: 800; margin: 20px 0 10px 0; display: flex; align-items: center; gap: 5px; }

        footer { text-align: center; font-size: 11px; color: #90a4ae; margin-top: 40px; padding-bottom: 30px; }
    </style>
</head>
<body>

<header>
    <img src="image_1.png" class="logo-clipart" alt="ì²­ê°œêµ¬ë¦¬" onerror="this.src='https://cdn-icons-png.flaticon.com/512/826/826963.png';">
    <h1 class="main-title">ì²­ê°œêµ¬ë¦¬ ì°½í˜¸ê²¬ì </h1>
    <span class="ver-badge">Ver 12.3 Custom Logo</span>
</header>

<div class="container" id="captureArea">
    <div class="top-section">
        <div class="address-row">
            <input type="text" id="aptAddress" placeholder="ì•„íŒŒíŠ¸/ê±´ë¬¼ëª… ê²€ìƒ‰" readonly onclick="openAddressSearch()">
            <button class="btn-search" onclick="openAddressSearch()">ğŸ”</button>
        </div>
        <input type="text" class="detail-input" id="detailAddress" placeholder="ë™/í˜¸ìˆ˜ ì…ë ¥">
        
        <button class="btn-auto-search" onclick="autoSearchBlueprint()">
            <span>ğŸš€</span> ìë™ ë„ë©´ ê²€ìƒ‰
        </button>

        <div class="alt-links">
            <a href="http://www.molit.go.kr/rtms/" target="_blank" class="alt-btn">ğŸ¢ êµ­í† ë¶€</a>
            <a href="https://urbanbase.com/" target="_blank" class="alt-btn">ğŸ  ì–´ë°˜ë² ì´ìŠ¤</a>
            <a href="https://realty.daum.net/" target="_blank" class="alt-btn">ğŸŸ¡ ë‹¤ìŒë¶€ë™ì‚°</a>
            <a href="https://cloud.eais.go.kr/" target="_blank" class="alt-btn">ğŸ“œ ì„¸ì›€í„°</a>
        </div>

        <div class="blueprint-display-area">
            <div class="bp-placeholder">
                <div style="font-size:32px; margin-bottom:8px;">ğŸ“‚</div>
                <div style="font-size:14px; font-weight:800; color:#546e7a;">ë„ë©´ì´ ë³´ì´ëŠ” ì¹¸</div>
                <div style="font-size:11px;">(ê²€ìƒ‰ëœ ë„ë©´ì„ ìº¡ì²˜ í›„ í„°ì¹˜í•˜ì—¬ ë“±ë¡)</div>
            </div>
            <img id="blueprintPreview" class="bp-img">
            <input type="file" accept="image/*" class="bp-file-input" onchange="handleBlueprintUpload(this)">
        </div>

        <button class="btn-no-blueprint" onclick="alertNoBlueprint()">âš ï¸ ë„ë©´ì„ ì°¾ì„ ìˆ˜ ì—†ë‚˜ìš”?</button>
    </div>

    <div id="inputListArea"></div>

    <div class="btn-group">
        <button class="btn-main btn-calc" onclick="calculateEstimates()">âœ¨ ê²¬ì  ì‚°ì¶œ</button>
        <button class="btn-main btn-save" onclick="saveAsImage()">ğŸ“¸ ì €ì¥</button>
    </div>

    <div class="chart-box" id="resultSection">
        <div id="resultPlaceholder" class="chart-placeholder-text">ì—…ì²´ë³„ ì°½í˜¸ì‹œê³µ ì´ ê²¬ì </div>
        <div id="graphContainer"></div>
        <div id="detailTableContainer"></div>
    </div>
</div>

<footer>
    ì²­ê°œêµ¬ë¦¬ìƒ¤ì‹œ | ê³ ê°ì„¼í„° 1599-7380<br>
    Copyright 2026 All Rights Reserved.
</footer>

<script>
    // [ì¤‘ìš”] ì—¬ê¸° ë”°ì˜´í‘œ ì•ˆì— ì•„ê¹Œ ë³µì‚¬í•œ êµ¬ê¸€ì‹œíŠ¸ CSV ë§í¬ë¥¼ ë„£ì–´ì£¼ì„¸ìš”!
    const GOOGLE_SHEET_CSV_URL = "ì—¬ê¸°ì—_ë³µì‚¬í•œ_ìƒˆ_ì£¼ì†Œë¥¼_ë¶™ì—¬ë„£ìœ¼ì„¸ìš”";

    let companyDB = {};

    // 1. ë‹¨ê°€í‘œ ë¡œë”©
    async function fetchPriceData() {
        try {
            const response = await fetch(GOOGLE_SHEET_CSV_URL);
            if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
            const text = await response.text();
            if (text.includes("<!DOCTYPE html>") || text.includes("google.com")) {
                alert("ğŸš¨ [ì˜¤ë¥˜] êµ¬ê¸€ ì‹œíŠ¸ ê²Œì‹œ í˜•ì‹ì„ 'CSV'ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.");
                return;
            }
            parseCSV(text);
        } catch (error) {
            console.error("ë¡œë”© ì‹¤íŒ¨:", error);
            alert("âŒ ë‹¨ê°€í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë§í¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
    }

    function parseSmartCSV(text) {
        const rows = [];
        let currentRow = [];
        let currentCell = '';
        let insideQuotes = false;
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];
            if (char === '"') {
                if (insideQuotes && nextChar === '"') { currentCell += '"'; i++; }
                else { insideQuotes = !insideQuotes; }
            } else if (char === ',' && !insideQuotes) {
                currentRow.push(currentCell.trim()); currentCell = '';
            } else if ((char === '\r' || char === '\n') && !insideQuotes) {
                if (char === '\r' && nextChar === '\n') i++;
                if (currentCell || currentRow.length > 0) currentRow.push(currentCell.trim());
                if (currentRow.length > 0) rows.push(currentRow);
                currentRow = []; currentCell = '';
            } else { currentCell += char; }
        }
        if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
        return rows;
    }

    function parseCSV(csvText) {
        const rows = parseSmartCSV(csvText);
        const newDB = {};
        
        rows.forEach((row, index) => {
            if (index === 0) return; 
            if (row.length < 5) return; 

            const code = row[0];        // Aì—´: ì½”ë“œ
            const comp = row[2];        // Cì—´: ì—…ì²´ëª…
            const itemName = row[5] || ""; // Fì—´: í’ˆëª©ëª…
            const itemSpec = row[6] || ""; // Gì—´: ìƒì„¸ìŠ¤í™
            
            let priceRaw = row[8] || "0"; // Iì—´: ê°€ê²©
            priceRaw = priceRaw.replace(/,/g, '').replace(/"/g, '');
            const price = parseInt(priceRaw);

            if (code && comp && !isNaN(price)) {
                if (!newDB[comp]) newDB[comp] = { name: comp, specs: {} };
                newDB[comp].specs[code] = { price: price, name: itemName, desc: itemSpec };
            }
        });

        if (Object.keys(newDB).length > 0) {
            companyDB = newDB;
            console.log("âœ… ë‹¨ê°€í‘œ ì—°ë™ ì™„ë£Œ");
        }
    }
    fetchPriceData();

    // 2. ê¸°ë³¸ ê¸°ëŠ¥
    let globalBlueprintFile = null;

    function openAddressSearch() {
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = data.roadAddress || data.jibunAddress;
                if(data.buildingName) addr += " (" + data.buildingName + ")";
                document.getElementById("aptAddress").value = addr;
            }
        }).open();
    }

    function autoSearchBlueprint() {
        const addr = document.getElementById("aptAddress").value;
        if (!addr) { alert("ì£¼ì†Œë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        const query = addr.split("(")[0].trim(); 
        const naverUrl = `https://m.land.naver.com/search/result/${encodeURIComponent(query)}`;
        if(confirm(`'${query}' ë„ë©´ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.\n\n1. í‰ë©´ë„ë¥¼ ìº¡ì²˜í•˜ì„¸ìš”.\n2. 'ë„ë©´ì´ ë³´ì´ëŠ” ì¹¸'ì— ë“±ë¡í•˜ì„¸ìš”.`)) {
            window.open(naverUrl, '_blank');
        }
    }

    function alertNoBlueprint() {
        alert("AIì‹¤ì¸¡ ë˜ëŠ” ì§ì ‘ ì‹¤ì¸¡ì„ ì´ìš©í•´ì£¼ì„¸ìš”.");
    }

    function handleBlueprintUpload(input) {
        if (input.files && input.files[0]) {
            globalBlueprintFile = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('blueprintPreview');
                img.src = e.target.result;
                img.style.display = 'block';
                document.querySelector('.bp-placeholder').style.display = 'none';
                alert("âœ… ë„ë©´ ë“±ë¡ ì™„ë£Œ!");
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // [ìˆ˜ì •] 1. ìƒˆë¡œìš´ ì¥ì†Œ ëª©ë¡ (11ê°œ)
    const defaultLocations = [
        "ê±°ì‹¤", "ì•ˆë°©", "ì¹¨ì‹¤1", "ì¹¨ì‹¤2", "ì¹¨ì‹¤3", "ì¹¨ì‹¤4", 
        "ë°œì½”ë‹ˆ1", "ë°œì½”ë‹ˆ2", "ì„¸íƒì‹¤", "ì£¼ë°©", "ì¤‘ë¬¸"
    ];
    
    // [ìˆ˜ì •] 2. ìœ„ì¹˜ ì„ íƒìš© ë“œë¡­ë‹¤ìš´ ì˜µì…˜ HTML ìƒì„±
    const locationOptionsHtml = defaultLocations.map(loc => `<option value="${loc}">${loc}</option>`).join('');

    const inputArea = document.getElementById('inputListArea');

    const windowOptions = `
        <option value="S_IN">ë‹¨ì°½ë‚´ë¶€ìš©</option>
        <option value="S_BAL">ë‹¨ì°½ì™¸ë¶€ìš©</option>
        <option value="D_IN">ì´ì¤‘ì°½ë‚´ë¶€ìš©</option>
        <option value="D_EXT">ì´ì¤‘ì°½ì™¸ë¶€ìš©</option>
        <option value="SYS">ë¶„í•©ì°½ë‚´ë¶€ìš©</option>
        <option value="TURNING">ì¤‘ë¬¸</option>
        <option value="PJ">ë£¨ë²„ì°½</option>
    `;

    // 11ê°œ ì¹¸ ìƒì„±
    defaultLocations.forEach((loc, index) => {
        let defaultType = "D_IN";
        if (loc.includes("ì¤‘ë¬¸")) defaultType = "TURNING";
        else if (loc.includes("ë°œì½”ë‹ˆ") || loc.includes("ì„¸íƒì‹¤")) defaultType = "S_BAL";
        else if (loc.includes("ê±°ì‹¤")) defaultType = "S_BAL";
        
        const currentOptions = windowOptions.replace(`value="${defaultType}"`, `value="${defaultType}" selected`);

        // [ìˆ˜ì •] 3. ìœ„ì¹˜ ì´ë¦„ì„ Select Boxë¡œ ë³€ê²½ (ìœ íš¨ì„± ê²€ì‚¬/ì„ íƒ ê°€ëŠ¥)
        // class="loc-select" ì ìš©, ê¸°ë³¸ê°’ì€ í•´ë‹¹ ìˆœì„œì˜ ìœ„ì¹˜ ì´ë¦„ìœ¼ë¡œ ì„ íƒë¨
        const locSelectOptions = defaultLocations.map(opt => 
            `<option value="${opt}" ${opt === loc ? 'selected' : ''}>${opt}</option>`
        ).join('');

        const html = `
            <div class="input-card">
                <div class="loading-overlay" id="loading_${index}">
                    <div class="spinner"></div>
                    <span style="font-size:11px; margin-top:5px; font-weight:bold;">AI ë¶„ì„ì¤‘..</span>
                </div>
                <div class="photo-area">
                    <div class="camera-icon" id="icon_${index}">ğŸ“·</div>
                    <div class="photo-hint" id="hint_${index}">ì‚¬ì§„ì´¬ì˜<br><strong>(A4ë¶€ì°©)</strong></div>
                    <img id="preview_${index}">
                    <input type="file" accept="image/*" class="photo-input-hidden" onchange="window.handleImageUpload(this, ${index})">
                </div>
                <div class="dim-area">
                    <div class="row-head">
                        <div>
                            <span class="row-number">NO.${index + 1}</span>
                            <select id="loc_${index}" class="loc-select" onchange="autoSelectType(this, ${index})">
                                ${locSelectOptions}
                            </select>
                        </div>
                        <div class="badge-ai" id="badge_${index}">ì™„ë£Œ</div>
                    </div>
                    <select id="type_${index}">${currentOptions}</select>
                    <div class="size-inputs">
                        <input type="number" id="w_${index}" placeholder="ê°€ë¡œ mm">
                        <input type="number" id="h_${index}" placeholder="ì„¸ë¡œ mm">
                    </div>
                </div>
            </div>
        `;
        inputArea.innerHTML += html;
    });

    // [ì‹ ê·œ] ìœ„ì¹˜ ë³€ê²½ ì‹œ, ì°½í˜¸ íƒ€ì…ë„ ë˜‘ë˜‘í•˜ê²Œ ë°”ê¿”ì£¼ëŠ” í•¨ìˆ˜
    window.autoSelectType = function(selectElem, index) {
        const loc = selectElem.value;
        const typeSelect = document.getElementById(`type_${index}`);
        
        if(loc.includes("ì¤‘ë¬¸")) typeSelect.value = "TURNING";
        else if(loc.includes("ë°œì½”ë‹ˆ") || loc.includes("ì„¸íƒì‹¤")) typeSelect.value = "S_BAL";
        else if(loc.includes("ê±°ì‹¤")) typeSelect.value = "S_BAL"; // ë³´í†µ ê±°ì‹¤ ë¶„í•©ì°½ì€ ë‹¨ì°½(ê³µí‹€)ì´ë‚˜ ë°œì½”ë‹ˆì°½ ì‚¬ìš©
        else typeSelect.value = "D_IN"; // ë°©ì€ ì´ì¤‘ì°½
    };

    // 3. ê²¬ì  ê³„ì‚° ë° ìƒì„¸ ì¶œë ¥
    function calculateEstimates() {
        let hasData = false;
        let reqList = [];

        for(let i=0; i<11; i++) { // 11ê°œë¡œ ì¦ê°€
            const w = parseFloat(document.getElementById(`w_${i}`).value) || 0;
            const h = parseFloat(document.getElementById(`h_${i}`).value) || 0;
            const type = document.getElementById(`type_${i}`).value;
            const typeName = document.getElementById(`type_${i}`).options[document.getElementById(`type_${i}`).selectedIndex].text;
            
            // [ìˆ˜ì •] ìœ„ì¹˜ ì´ë¦„ì„ hidden inputì´ ì•„ë‹Œ select boxì—ì„œ ê°€ì ¸ì˜´
            const locName = document.getElementById(`loc_${i}`).value;

            if (w > 0 && h > 0) {
                let qty = (type === "TURNING") ? 1 : (w * h) / 90000;
                reqList.push({ 
                    loc: locName, type: type, typeName: typeName, 
                    w: w, h: h, qty: qty 
                });
                hasData = true;
            }
        }

        if (!hasData) { alert("ì¹˜ìˆ˜ë¥¼ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        if (Object.keys(companyDB).length === 0) { alert("âŒ ë‹¨ê°€í‘œ ë¡œë”© ì‹¤íŒ¨."); return; }

        let results = [];
        for (const [compName, data] of Object.entries(companyDB)) {
            let sum = 0;
            reqList.forEach(item => {
                const specData = data.specs[item.type];
                if (specData) {
                    sum += specData.price * item.qty;
                }
            });
            if (sum > 0) results.push({ name: compName, cost: Math.floor(sum) });
        }

        const resultBox = document.getElementById('resultSection');
        const container = document.getElementById('graphContainer');
        const detailContainer = document.getElementById('detailTableContainer');
        
        document.getElementById('resultPlaceholder').style.display = 'none';
        resultBox.style.display = 'block';
        
        container.innerHTML = `<h3 style="margin:0 0 15px 0; text-align:center; font-size:17px; font-weight:800; color:#222;">ğŸ“Š ì—…ì²´ë³„ ì°½í˜¸ì‹œê³µ ì´ ê²¬ì </h3>`;

        results.sort((a, b) => a.cost - b.cost);
        
        if(results.length > 0) {
            const maxCost = results[results.length - 1].cost;
            results.forEach((item, idx) => {
                const percent = (item.cost / maxCost) * 100;
                const barClass = idx === 0 ? 'g-bar best' : (idx === 1 ? 'g-bar second' : 'g-bar');
                container.innerHTML += `
                    <div class="graph-row">
                        <div class="g-label">${item.name}</div>
                        <div class="g-bar-bg"><div class="${barClass}" style="width:${percent}%"></div></div>
                        <div class="g-price">${item.cost.toLocaleString()}ì›</div>
                    </div>`;
            });

            const bestCompany = results[0].name; 
            const bestCompData = companyDB[bestCompany];
            
            let detailHtml = `
                <div class="detail-table-area">
                    <div class="d-title">ğŸ“‘ ìƒì„¸ ê²¬ì  ëª…ì„¸ì„œ <span style="font-size:12px; color:#1a73e8; font-weight:normal;">(${bestCompany} ê¸°ì¤€)</span></div>
                    <table class="d-table">
                        <thead>
                            <tr>
                                <th width="15%">ìœ„ì¹˜</th>
                                <th width="20%">êµ¬ë¶„</th>
                                <th width="25%">ê·œê²©/ìŠ¤í™</th>
                                <th width="15%">ìˆ˜ëŸ‰</th>
                                <th width="25%">ì˜ˆìƒê¸ˆì•¡</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let totalSum = 0;
            reqList.forEach(item => {
                const specInfo = bestCompData.specs[item.type];
                let price = 0;
                let specText = "-";
                
                if (specInfo) {
                    price = Math.floor(specInfo.price * item.qty);
                    specText = `${specInfo.name || ""}<br><span style="color:#888; font-size:11px;">${specInfo.desc || ""}</span>`;
                } else {
                    specText = "<span style='color:red;'>ë‹¨ê°€ì—†ìŒ</span>";
                }
                
                const qtyDisplay = (item.type === "TURNING") ? "1ì‹" : `${item.qty.toFixed(1)}í‰`;
                
                detailHtml += `
                    <tr>
                        <td>${item.loc}</td>
                        <td class="left">${item.typeName}</td>
                        <td class="left">${item.w}x${item.h}<br>${specText}</td>
                        <td>${qtyDisplay}</td>
                        <td style="font-weight:bold; color:#1a73e8;">${price.toLocaleString()}</td>
                    </tr>
                `;
                totalSum += price;
            });
            
            detailHtml += `
                        <tr style="background:#f9f9f9; font-weight:bold;">
                            <td colspan="4" style="text-align:right; padding-right:15px;">ì´ í•©ê³„</td>
                            <td style="color:#d32f2f; font-size:13px;">${totalSum.toLocaleString()}ì›</td>
                        </tr>
                    </tbody>
                </table>
                <div class="estimate-note">
                    <p>â€» ìœ„ ìƒì„¸ ë‚´ì—­ì€ <strong>${bestCompany}</strong>ì˜ ë‹¨ê°€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìë™ ì‚°ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    <p>â€» ì—…ì²´ë³„ë¡œ ìì¬ ì‚¬ì–‘(ìœ ë¦¬ ë‘ê»˜ ë“±)ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <p>â€» <strong>ë³„ë„ ë¹„ìš©:</strong> ì² ê±°ë¹„, ì‚¬ë‹¤ë¦¬ì°¨, ë§ˆê°ê³µì‚¬ë¹„ ë“±ì€ ì œì™¸ëœ ê¸ˆì•¡ì…ë‹ˆë‹¤.</p>
                </div>
            </div>`;

            detailContainer.innerHTML = detailHtml;

        } else {
            container.innerHTML += "<div style='text-align:center;'>ê²¬ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
        }
        
        resultBox.scrollIntoView({behavior: "smooth"});
    }

    function saveAsImage() {
        window.scrollTo(0,0);
        setTimeout(() => {
            html2canvas(document.body).then(canvas => {
                const link = document.createElement('a');
                link.download = 'ì²­ê°œêµ¬ë¦¬_ìƒì„¸ê²¬ì .png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }, 200);
    }
</script>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    const p1 = "AIzaSyAq7G2mE2qFuUi";
    const p2 = "f-";
    const p3 = "PgPDsXl1ppbY5_JK54";
    const API_KEY = p1 + p2 + p3;

    window.handleImageUpload = async function(inputElement, index) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById(`icon_${index}`).style.display = 'none';
            document.getElementById(`hint_${index}`).style.display = 'none';
            const img = document.getElementById(`preview_${index}`);
            img.src = e.target.result;
            img.style.display = 'block';
        }
        reader.readAsDataURL(file);

        const loading = document.getElementById(`loading_${index}`);
        loading.style.display = 'flex';

        try {
            const genAI = new GoogleGenerativeAI(API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });
            
            const imagePart = await fileToGenerativePart(file);
            // [ìˆ˜ì •] select boxì—ì„œ í˜„ì¬ ì„ íƒëœ ìœ„ì¹˜ ì´ë¦„ì„ ê°€ì ¸ì˜´
            const locationName = document.getElementById(`loc_${index}`).value;
            
            let parts = [imagePart];
            let prompt = "";

            if (window.globalBlueprintFile) {
                const blueprintPart = await fileToGenerativePart(window.globalBlueprintFile);
                parts.push(blueprintPart);
                prompt = `
                    ë‹¹ì‹ ì€ ì°½í˜¸ ê²¬ì  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                    [ì´ë¯¸ì§€1: í˜„ì¥ ì‚¬ì§„, ì´ë¯¸ì§€2: í‰ë©´ë„]
                    ë„ë©´ì—ì„œ **${locationName}** ìœ„ì¹˜ë¥¼ ì°¾ì•„ ì •í™•í•œ ì¹˜ìˆ˜(mm)ë¥¼ ì½ì–´ë‚´ì„¸ìš”.
                `;
            } else {
                prompt = `
                    ë‹¹ì‹ ì€ ì°½í˜¸ ê²¬ì  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                    ì‚¬ì§„ ì† **${locationName}** ì°½ë¬¸ì˜ ì „ì²´ í”„ë ˆì„ í¬ê¸°(mm)ë¥¼ A4ìš©ì§€(210x297mm) ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•˜ì„¸ìš”.
                `;
            }

            prompt += `
                ì‘ë‹µì€ ì˜¤ì§ JSONìœ¼ë¡œë§Œ:
                {
                    "typeCode": "ë¬¸ìì—´ (S_IN, S_BAL, D_IN, D_EXT, SYS, TURNING, PJ ì¤‘ í•˜ë‚˜)",
                    "width": ìˆ«ì (mm),
                    "height": ìˆ«ì (mm)
                }
            `;
            parts.unshift(prompt);

            const result = await model.generateContent(parts);
            const response = await result.response;
            const text = response.text().replace(/```json|```/g, "").trim();
            const data = JSON.parse(text);

            if(data.typeCode) document.getElementById(`type_${index}`).value = data.typeCode;
            if(data.width) document.getElementById(`w_${index}`).value = data.width;
            if(data.height) document.getElementById(`h_${index}`).value = data.height;
            document.getElementById(`badge_${index}`).style.display = 'block';

        } catch (error) {
            console.error(error);
            alert("AI ë¶„ì„ ì‹¤íŒ¨. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        } finally {
            loading.style.display = 'none';
        }
    };

    async function fileToGenerativePart(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64Data = reader.result.split(',')[1];
                resolve({ inlineData: { data: base64Data, mimeType: file.type } });
            };
            reader.readAsDataURL(file);
        });
    }
</script>

</body>
</html>
